<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endless Turn-Based RPG</title>
    <style>
    
    #gameContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 800px;
    margin: 0 auto;
}
        #gameCanvas {
    display: none;
    border: 1px solid black;
    width: 100%;
    max-width: 800px;
    height: auto;
}

#gameButtons, #gameNotifications, #gameVictoryScreen, #gameDefeatScreen, #campScreen, #storyEventScreen, #characterSelectScreen {
    display: none; /* Initially hide all game elements */
}

#gameButtons {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 10px;
    width: 100%;
    position: relative; /* Add this line */
    z-index: 10; /* Add this line */
    
}

#gameButtons button {
    margin: 5px;
    padding: 10px 20px;
    font-size: 16px;
}

#mainMenu {
    text-align: center;
    margin-top: 100px;
}

#startGameButton {
    font-size: 20px;
    padding: 10px 20px;
}


    @keyframes glow {
        0% {
            box-shadow: 0 0 5px #ff00de;
        }
        50% {
            box-shadow: 0 0 20px #ff00de;
        }
        100% {
            box-shadow: 0 0 5px #ff00de;
        }
    }

    #specialAttackButton {
        display: none;
        padding: 10px 20px;
        font-size: 16px;
        border: 2px solid #ff00de;
        background-color: #4a0e4e;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #specialAttackButton.available {
        animation: glow 1.5s infinite;
    }

    #specialAttackButton.cooldown {
        animation: none;
        background-color: #666;
        border-color: #999;
        color: #ccc;
        cursor: not-allowed;
    }

#characterSelectScreen {
    text-align: center;
    margin-top: 100px;
}

.character-options {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
}

.character-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 10px;
}

.character-sprite-select {
  width: 150px;  /* Adjust size as needed */
  height: auto;
  margin-bottom: 10px;
}


#shop {
        text-align: center;
    }

    .shop-items {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 5px;
    }

    .shop-item {
        display: inline-block;
        vertical-align: top;
        margin: 0 2px 10px;
        width: 140px;  /* Adjust this width as needed */
    }

    #shop .shop-item button {
        display: block;
        width: 100%;
        margin-bottom: 5px;
        padding: 5px 2px; /* Adjusted padding */
        white-space: normal; /* Allow text to wrap */
        height: auto; /* Allow button to expand vertically */
        line-height: 1.2; /* Adjust line spacing */
        text-align: center;
    }
    
    .button-content {
  display: flex;
  flex-direction: column;
  align-items: center;
}
    .item-description {
        display: block;
        font-size: 0.9em;
        color: #000;
        text-align: center;
    }
    
    .gold-amount {
  font-size: 0.8em;
  color: #333; /* Gold color */
}

#campShop {
    text-align: center;
    margin-top: 20px;
}

#campShop .shop-items {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 5px;
}

#campShop .shop-item {
    display: inline-block;
    vertical-align: top;
    margin: 0 2px 10px;
    width: 140px;
}

#campShop .shop-item button {
    display: block;
    width: 100%;
    margin-bottom: 5px;
    padding: 5px 2px;
    white-space: normal;
    height: auto;
    line-height: 1.2;
    text-align: center;
}

#campShop .button-content {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#campShop .item-description {
    display: block;
    font-size: 0.9em;
    color: #000;
    text-align: center;
}

#campShop .gold-amount {
    font-size: 0.8em;
    color: #333;
}

.tentButton {
    display: block;
    width: 200px;
    height: 50px;
    margin: 10px auto;
    font-size: 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
}

.tentButton:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

#tentSquares {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin-bottom: 20px;
}

.tentRow {
    display: flex;
    flex-direction: row;
    justify-content: center;
    width: 100%;
    margin-bottom: 10px;
}

.tentSquare {
    width: 80px;
    height: 80px;
    background-color: #f0f0f0;
    border: 2px solid #333;
    margin: 0 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 12px;
}



#continueJourneyFromCampButton {
    display: block;
    width: 200px;
    height: 50px;
    margin: 20px auto;
    font-size: 16px;
    background-color: #707070;
    color: white;
    border: none;
    cursor: pointer;
}

.bigButton {
    font-size: 1em;
    padding: 5px 10px;
    margin: 5px;
}

/* Add any additional styles for other elements here */
        #developerGoldButton {
            //background-color: #FFD700;
            //color: #000;
            //padding: 10px 20px;
            //margin: 10px;
            //border: none;
            //cursor: pointer;
        }
        
        #developerGoldButton:hover {
           background-color: #FFA500;
        }
        
        
        @media (max-width: 768px) {
          
          .shop-items {
            flex-direction: column;
        }

        .shop-item {
            width: 100%;
        }

        .item-description {
            font-size: 0.9em;
        }
        
    #gameCanvas {
        width: 100%;
        height: auto;
        max-width: 800px;
        max-height: 500px;
    }

    #gameButtons {
        position: fixed;
        bottom: 10px;
        left: 0;
        right: 0;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 10px;
    }

    #mobileMenu {
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 1000;
    }

    #menuToggle {
        font-size: 24px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
    }

    #menuContent {
        background: rgba(0,0,0,0.8);
        padding: 10px;
        border-radius: 5px;
    }

    #menuContent button {
        display: block;
        width: 100%;
        margin: 5px 0;
        padding: 10px;
    }

    .bigButton {
        font-size: 1.2em;
        padding: 10px 20px;
    }
}
    </style>
</head>
<body>
    <div id="mainMenu">
        <h1>Endless Turn-Based RPG</h1>
        <button id="startGameButton">Start New Game</button>
        <br><br>
        <button id="loadGameButton">Load Game</button>
    </div>
    <div id="characterSelectScreen">
  <h2>Select Your Character</h2>
  <div class="character-options">
    <div class="character-option">
      <img src="images/warrior-sprite.png" alt="Warrior" class="character-sprite-select">
      <button id="warriorButton">Warrior</button>
    </div>
    <div class="character-option">
      <img src="images/mage-sprite.png" alt="Mage" class="character-sprite-select">
      <button id="mageButton">Mage</button>
    </div>
    <div class="character-option">
      <img src="images/cleric-sprite.png" alt="Cleric" class="character-sprite-select">
      <button id="clericButton">Cleric</button>
    </div>
    <div class="character-option">
      <img src="images/rogue-sprite.png" alt="Rogue" class="character-sprite-select">
      <button id="rogueButton">Rogue</button>
    </div>
  </div>
</div>
    <div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    <div id="characterSprite"></div>
    <div id="gameButtons">
        <button id="attackButton">Attack</button>
        <button id="defendButton">Defend</button>
        <button id="specialAttackButton" style="display: none;">Special Attack</button>
        <button id="retreatButton">Retreat</button>
    </div>
</div>
    <div id="gameNotifications">
        <p id="notificationText"></p>
    </div>
    <div id="gameVictoryScreen" style="display: none; text-align: center;">
        <h1>Victory!</h1>
        <p id="victoryMessage"></p>
        <p id="goldMessage"></p>
        <button id="developerGoldButton">Developer Gold</button>
                <div id="shop">
    <h2>Shop</h2>
    <div class="shop-items">
        <div class="shop-item">
            <button id="healingPotionButton">
                <div class="button-content">
                    <span class="item-name">Buy Healing Potion</span>
                    <span class="gold-amount">100 Gold</span>
                </div>
            </button>
            <span class="item-description">Heal 25 HP</span>
        </div>
        <div class="shop-item">
            <button id="expBoosterButton">
                <div class="button-content">
                    <span class="item-name">Buy EXP Booster</span>
                    <span class="gold-amount">200 Gold</span>
                </div>
            </button>
            <span class="item-description">Double the next XP gained</span>
        </div>
        <div class="shop-item">
            <button id="antidoteButton">
                <div class="button-content">
                    <span class="item-name">Buy Antidote</span>
                    <span class="gold-amount">300 Gold</span>
                </div>
            </button>
            <span class="item-description">Heals poison</span>
        </div>
        <div class="shop-item">
            <button id="lotusButton">
                <div class="button-content">
                    <span class="item-name">Buy Lotus of Experience</span>
                    <span class="gold-amount">500 Gold</span>
                </div>
            </button>
            <span class="item-description">Grants 10 XP</span>
        </div>
        <div class="shop-item">
            <button id="redPillButton">
                <div class="button-content">
                    <span class="item-name">Buy Red Pill</span>
                    <span class="gold-amount">1000 Gold</span>
                </div>
            </button>
            <span class="item-description">+1 Min Damage</span>
        </div>
    </div>
</div>
        <br><br>
        <div id="journeyButtons">
            <button id="continueJourneyButton" class="bigButton">Continue Journey</button>
            <button id="returnToCampButton" class="bigButton">Return to Camp</button>
        </div>
        <div id="skillSelection" style="display: none;">
    <h2>Choose Your Special Skill</h2>
    <div id="skillSelectionMageSkills" style="display: none;">
        <button id="thunderButton">Thunder</button>
        <button id="fireballButton">Fireball</button>
        <button id="hailStormButton">Hail Storm</button>
    </div>
    <div id="skillSelectionWarriorSkills" style="display: none;">
        <button id="doubleAttackButton">Double Attack</button>
        <button id="stoneSkinButton">Stone Skin</button>
        <button id="lifeAttackButton">Life Attack</button>
    </div>
    <div id="skillSelectionClericSkills" style="display: none;">
        <button id="holyLightButton">Holy Light</button>
        <button id="lifeTransferButton">Life Transfer</button>
        <button id="shieldOfLightButton">Shield of Light</button>
    </div>
    <div id="skillSelectionRogueSkills" style="display: none;">
        <button id="blindShotButton">Blind Shot</button>
        <button id="toxicStabButton">Toxic Stab</button>
        <button id="perfectParryButton">Perfect Parry</button>
    </div>
    
</div>
        <!-- <button id="continueJourneyButton">Continue Journey</button>
        <button id="returnToCampButton">Return to Camp</button>
        <button id="developerButton">Level Up to 3</button>
        <button id="developerButton5">Level Up to 5</button> -->
    </div>
    <div id="duelVictoryScreen" style="display: none; text-align: center;">
        <h1>Duel Victory!</h1>
        <p id="duelVictoryMessage"></p>
        <button id="recruitButton">Recruit Character</button>
        <button id="continueDuelJourneyButton">Continue Journey</button>
    </div>
    <div id="gameDefeatScreen" style="display: none; text-align: center;">
        <h1>Defeat!</h1>
        <p>You have been defeated.</p>
        <button id="tryAgainButton">Try Again</button>
    </div>
    <div id="campScreen" style="display: none; text-align: center;">
    <h1>Camp</h1>
    <p>Store your gold in the Camp Bank for safekeeping.</p>
    <button id="storeGoldButton">Store All Gold</button>
    <p id="campMessage"></p>
    <div id="tentSquares">
        <div id="playerTentsRow" class="tentRow"></div>
        <div id="commercialTentsRow" class="tentRow"></div>
    </div>
    <div id="tentUpgrades">
        <button id="secondTentButton" class="tentButton">Buy Second Tent (1500 Gold)</button>
        <button id="thirdTentButton" class="tentButton" style="display: none;">Buy Third Tent (2000 Gold)</button>
        <button id="fourthTentButton" class="tentButton" style="display: none;">Buy Fourth Tent (2500 Gold)</button>
        <button id="fifthTentButton" class="tentButton" style="display: none;">Buy Fifth Tent (3000 Gold)</button>
        <button id="merchantTentButton" class="tentButton">Buy Merchant Tent (1000 Gold)</button>
    </div>
    <button id="continueJourneyFromCampButton">Continue Journey</button>
    <button id="saveGameButton">Save Game</button>
</div>
    <div id="storyEventScreen" style="display: none; text-align: center;">
        <h1>Story Event</h1>
        <p id="storyText"></p>
        <div id="storyChoices">
            <button id="storyChoice1Button"></button>
            <button id="storyChoice2Button"></button>
            <button id="storyChoice3Button"></button>
        </div>
        <div id="storySkillSelection" style="display: none;">
    <h2>Choose Your Special Skill</h2>
    <div id="storySkillSelectionMageSkills" style="display: none;">
        <button id="storyThunderButton">Thunder</button>
        <button id="storyFireballButton">Fireball</button>
        <button id="storyHailStormButton">Hail Storm</button>
    </div>
    <div id="storySkillSelectionWarriorSkills" style="display: none;">
        <button id="storyDoubleAttackButton">Double Attack</button>
        <button id="storyStoneSkinButton">Stone Skin</button>
        <button id="storyLifeAttackButton">Life Attack</button>
    </div>
    <div id="storySkillSelectionClericSkills" style="display: none;">
        <button id="storyHolyLightButton">Holy Light</button>
        <button id="storyLifeTransferButton">Life Transfer</button>
        <button id="storyShieldOfLightButton">Shield of Light</button>
    </div>
    <div id="storySkillSelectionRogueSkills" style="display: none;">
        <button id="storyBlindShotButton">Blind Shot</button>
        <button id="storyToxicStabButton">Toxic Stab</button>
        <button id="storyPerfectParryButton">Perfect Parry</button>
    </div>
</div>
        <p id="storyStats"></p>
        <p id="storyLevelUpMessage" style="display: none;"></p>
        <button id="continueJourneyFromStoryButton" style="display: none;">Continue Journey</button>
        <button id="continueToBattleButton" style="display: none;">Continue to Battle</button>
    </div>
    <div id="duelEventScreen" style="display: none; text-align: center;">
    <h2>Duel Challenge</h2>
    <p id="duelText"></p>
    <button id="startDuelButton">Start Duel</button>
</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let player = {
    class: '',
    specialSkills: {},
    specialAttackCooldown: 0,
    health: 50,
    maxHealth: 50,
    minDamage: 1,
    maxDamage: 6,
    experience: 0,
    level: 1,
    xpToNextLevel: 20,
    gold: 0,
    campBank: 0,
    expBooster: false,
    defending: false,
    specialAttackCooldown: 0,
    specialSkillUnlocked: false,
    specialSkill: null,
    healthGain: 0,
    minDamageGain: 0,
    maxDamageGain: 0,
    tents: 1,
    poisonCounter: 0
    
};

player.purchasedItems = {
    healingPotion: false,
    expBooster: false,
    antidote: false,
    lotus: false,
    redPill: false
};

        const enemyTypes = [
            { type: 'Goblin', baseHP: 20, minDamage: 1, maxDamage: 6, xp: 10 },
            { type: 'Wolf', baseHP: 25, minDamage: 2, maxDamage: 6, xp: 11 },
            { type: 'Orc', baseHP: 30, minDamage: 2, maxDamage: 7, xp: 12 },
            { type: 'Poisonous Plant', baseHP: 28, minDamage: 2, maxDamage: 8, xp: 13 },
            { type: 'Werewolf', baseHP: 35, minDamage: 2, maxDamage: 9, xp: 14 },
            { type: 'Troll', baseHP: 40, minDamage: 3, maxDamage: 8, xp: 15 },
            { type: 'Dragon', baseHP: 70, minDamage: 5, maxDamage: 12, xp: 20 },
            { type: 'Skeletal Warrior', baseHP: 45, minDamage: 4, maxDamage: 10, xp: 18 },
            { type: 'Treant', baseHP: 75, minDamage: 6, maxDamage: 14, xp: 25 }
        ];
        
        const characterSprites = {};

        let enemies = []; // Initialize enemies array
        
        let duelEventsUnlocked = false;
        
        let isProcessingPurchase = false;
		
        let selectedEnemyIndex = 0; // Track the selected enemy

        let damageDisplay = {
            player: { damage: 0, x: 0, y: 0, alpha: 0 },
            enemy: { damage: 0, x: 0, y: 0, alpha: 0 }
        };

        let healingDisplay = {
            amount: 0,
            x: 0,
            y: 0,
            alpha: 0
        };

        let gameState = 'mainMenu'; // Start with the main menu
        let victoryExpGained = 0;
        let currentBattleExpGained = 0; // Track XP gained from the current battle
        let victoryLevelUpMessage = '';
        let inStoryEvent = false; // Flag to indicate if we are in a story event
        let treantEncountered = false; // Track if the player has encountered the Treant
        let currentVictoryScreenPurchases = {};

        // Flags for story events
        let currentStory = null;
        const STORY_OLD_MAN = 'old_man';
        const STORY_TREANT = 'treant';
        
        function initGame() {
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'none';
            document.getElementById('gameNotifications').style.display = 'none';
            document.getElementById('gameVictoryScreen').style.display = 'none';
            document.getElementById('gameDefeatScreen').style.display = 'none';
            document.getElementById('campScreen').style.display = 'none';
            document.getElementById('storyEventScreen').style.display = 'none';
            document.getElementById('characterSelectScreen').style.display = 'none';
            
            if (isMobile()) {
                createMobileEnemySelectionOverlay();
                canvas.addEventListener('touchstart', handleMouseClick, false);
                } else {
                    canvas.addEventListener('click', handleMouseClick, false);
                }
            }
            

        function loadCharacterSprite(characterClass) {
    if (!characterSprites[characterClass]) {
        const img = new Image();
        img.src = `images/${characterClass.toLowerCase()}-sprite.png`;
        characterSprites[characterClass] = img;
    }
    return characterSprites[characterClass];
}

        // Call initGame when the page loads
        window.onload = initGame;

        function createEnemyByType(type) {
            const enemyType = enemyTypes.find(enemy => enemy.type === type);
            return {
                type: enemyType.type,
                health: enemyType.baseHP,
                maxHealth: enemyType.baseHP,
                minDamage: enemyType.minDamage,
                maxDamage: enemyType.maxDamage
            };
        }

        function createEnemies(playerLevel) {
            let enemies = [];
            const doubleBattleChance = Math.random();
            const numberOfEnemies = playerLevel >= 5 && doubleBattleChance <= 0.25 ? 2 : 1;

            for (let i = 0; i < numberOfEnemies; i++) {
                let possibleEnemies = treantEncountered ? enemyTypes : enemyTypes.filter(type => type.type !== 'Treant');
                let enemyIndex;
                if (playerLevel < 3) {
                    enemyIndex = Math.floor(Math.random() * 2); // Goblin or Wolf
                } else if (playerLevel < 4) {
                    enemyIndex = Math.floor(Math.random() * 4); // Goblin, Wolf, Orc
                } else if (playerLevel < 5) {
                    enemyIndex = Math.floor(Math.random() * 5); // Goblin, Wolf, Orc, Werewolf
                } else {
                    enemyIndex = Math.floor(Math.random() * possibleEnemies.length);
                }
                enemies.push(createEnemyByType(possibleEnemies[enemyIndex].type));
            }
            return enemies.map(enemy => ({
				...enemy,
				stunnedTurns: 0,
				burnedTurns: 0
			}));
		}
		
	  let resizeTimeout;
		
    function addButtonListeners() {
    document.getElementById('attackButton').onclick = playerAttack;
    document.getElementById('defendButton').onclick = playerDefend;
    document.getElementById('retreatButton').onclick = playerRetreat;
    document.getElementById('specialAttackButton').onclick = playerSpecialAttack;
}

        // Call it initially to set up the correct size
        window.addEventListener('resize', function() {
    if (isMobile()) {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            resizeGame();
            addButtonListeners();
        }, 100);
    }
});

        function startGame(isNewGame = true) {
    console.log("startGame function called, isNewGame:", isNewGame);
    
    if (isNewGame) {
        // Reset player and game state to initial values
        player = {
            class: '',
            health: 50,
            maxHealth: 50,
            minDamage: 1,
            maxDamage: 6,
            experience: 0,
            level: 1,
            xpToNextLevel: 20,
            gold: 0,
            campBank: 0,
            specialAttackCooldown: 0,
            specialSkill: null,
            specialSkillUnlocked: false,
            poisonCounter: 0,
            tents: 1
            // Add any other initial player properties here
        };
        
        gameState = 'characterSelect';
        currentStory = null;
        treantEncountered = false;
        duelEventsUnlocked = false;
        resetPurchasedItems();

        hideAllScreens();
        document.getElementById('characterSelectScreen').style.display = 'block';
    } else {
        // This is a loaded game
        hideAllScreens();
        showCampScreen();
    }

    addButtonListeners();
    updateLoadGameButton();
    
    if (isMobile()) {
        resizeGame();
    }
}

        function startBattle(characterClass) {
    console.log("Starting battle with class:", characterClass || player.class);
    console.log("Player special skill:", player.specialSkill);
    if (characterClass) {
        player.class = characterClass;
        setupClassSkills();
        loadCharacterSprite(characterClass); // Load the sprite
    }
    
    hideAllScreens();
    
    const gameContainer = document.getElementById('gameContainer');
    gameContainer.style.display = 'flex';
    
    document.getElementById('gameCanvas').style.display = 'block';
    document.getElementById('gameButtons').style.display = 'flex';
    
       // Update the special attack button
    //updateSpecialAttackButton();
    
    currentBattleExpGained = 0;
    gameState = 'playerTurn';
    updateButtonStates();
    enemies = createEnemies(player.level);
    
    if (isMobile()) {
        resizeGame();
    }
    
    drawGame();
    animateDamage();
}

// Modify the event listeners for character selection buttons
document.getElementById('warriorButton').addEventListener('click', () => startBattle('Warrior'));
document.getElementById('mageButton').addEventListener('click', () => {
    startBattle('Mage');
});
document.getElementById('clericButton').addEventListener('click', () => startBattle('Cleric'));
document.getElementById('rogueButton').addEventListener('click', () => startBattle('Rogue'));

        let lastPoisonStatus = null;
        

    function drawGame() {
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, 800, 500);
    
    ctx.textAlign = "left";
    ctx.textBaseline = "top";

    // Draw player
    if (player.class && characterSprites[player.class]) {
        const sprite = characterSprites[player.class];
        const spriteWidth = 153;  // Half of 306
        const spriteHeight = 196.5;  // Half of 393
        const spriteX = 25;  // Adjust this value to move sprite horizontally
        const spriteY = 180;  // Adjust this value to move sprite lower
        ctx.drawImage(sprite, spriteX, spriteY, spriteWidth, spriteHeight);
    } else {
        ctx.fillStyle = 'blue';
        ctx.fillRect(50, 180, 50, 50);
    }
    
    if (player.class) {
        ctx.fillStyle = 'black';
        ctx.font = '16px Arial';
        ctx.fillText(player.class, 80, 385);
    }
    
    // Draw player status effects
    let playerStatusY = 260;
    const drawStatus = (text, color) => {
        ctx.fillStyle = color;
        ctx.font = '14px Arial';
        ctx.fillText(text, 50, playerStatusY);
        playerStatusY += 20;
    };

    if (player.defending) drawStatus('Defending', 'blue');
    if (player.burnedTurns > 0) drawStatus(`Burned (${player.burnedTurns} turns)`, 'orange');
    if (player.poisonCounter && player.poisonCounter > 0) {
        const poisonStatus = `Poisoned (${player.poisonCounter - 1} damage next turn)`;
        drawStatus(poisonStatus, 'purple');
        if (poisonStatus !== lastPoisonStatus) {
            console.log(`Drawing poison status: ${poisonStatus}`);
            lastPoisonStatus = poisonStatus;
        }
    } else if (lastPoisonStatus !== null) {
        console.log("Player no longer poisoned");
        lastPoisonStatus = null;
    }
    if (player.blind) drawStatus(`Blinded (${player.blind}% chance)`, 'gray');
    if (player.parry) drawStatus('Parry Ready', 'red');
    if (player.shieldOfLight > 0) drawStatus(`Shield of Light (${player.shieldOfLight} turns)`, 'yellow');

    // Draw enemies
    enemies.forEach((enemy, index) => {
        const baseYOffset = 180 + (index * 130);
        const yOffset = index === 0 ? baseYOffset - 20 : baseYOffset;
        const hpBarYOffset = yOffset - 30;
        const hpTextYOffset = hpBarYOffset - 10;
        const typeTextYOffset = yOffset + 75;

        // In the drawGame function, replace the part you mentioned with this:
if (enemies.length > 1) {
    if (isMobile()) {
        // For mobile, we'll use the overlay created earlier
        const overlay = document.getElementById('mobileEnemySelectionOverlay');
        overlay.style.display = 'block';
    } else {
        // For desktop, we'll keep the existing selection indicator
        if (index === selectedEnemyIndex) {
            ctx.strokeStyle = 'yellow';
            ctx.lineWidth = 5;
            ctx.strokeRect(645, yOffset - 5, 60, 60);
        }
    }
}

        ctx.fillStyle = 'red';
        ctx.fillRect(650, yOffset, 50, 50);

        ctx.fillStyle = 'green';
        ctx.fillRect(540, hpBarYOffset, (enemy.health / enemy.maxHealth) * 200, 20);

        ctx.fillStyle = 'black';
        ctx.font = '20px Arial';
        ctx.fillText(`Enemy Health: ${enemy.health}`, 540, hpBarYOffset - 25); // Changed from hpTextYOffset to hpBarYOffset - 10
        ctx.fillText(`${enemy.type}`, 650, typeTextYOffset);

        let statusY = typeTextYOffset + 20;
        const drawEnemyStatus = (text, color = 'black') => {
            ctx.fillStyle = color;
            ctx.font = '14px Arial';
            ctx.fillText(text, 650, statusY);
            statusY += 20;
        };

        if (enemy.defending) drawEnemyStatus('Defending');
        if (enemy.stunnedTurns > 0) drawEnemyStatus('Stunned', 'yellow');
        if (enemy.burnedTurns > 0) drawEnemyStatus('Burned', 'orange');
        if (enemy.exposed) drawEnemyStatus('Exposed', 'green');
        if (enemy.blind) drawEnemyStatus(`Blind (${enemy.blind}%)`, 'gray');
        if (enemy.poison && enemy.poison > 0) drawEnemyStatus(`Poisoned (${enemy.poison})`, 'purple');
    });

    // Draw player stats
    ctx.fillStyle = 'green';
    ctx.fillRect(10, 10, (player.health / player.maxHealth) * 200, 20);

    ctx.fillStyle = 'black';
    ctx.font = '20px Arial';
    ctx.fillText(`Player Health: ${player.health}`, 10, 50);
    ctx.fillText(`Player Level: ${player.level}`, 10, 80);
    ctx.fillText(`Player XP: ${player.experience}/${player.xpToNextLevel}`, 10, 110);
    ctx.fillText(`Gold: ${player.gold}`, 10, 140);
    ctx.fillText(`Camp Bank: ${player.campBank} Gold`, 10, 470);

    displayDamage();
    updateSpecialAttackButton();
    drawTurnIndicator();
}

        function displayDamage() {
            ctx.font = '20px Arial';
            ctx.fillStyle = `rgba(255, 0, 0, ${damageDisplay.enemy.alpha})`;
            ctx.fillText(`-${damageDisplay.enemy.damage}`, damageDisplay.enemy.x, damageDisplay.enemy.y);

            ctx.fillStyle = `rgba(0, 0, 255, ${damageDisplay.player.alpha})`;
            ctx.fillText(`-${damageDisplay.player.damage}`, damageDisplay.player.x, damageDisplay.player.y);

            ctx.fillStyle = `rgba(0, 255, 0, ${healingDisplay.alpha})`;
            ctx.fillText(`+${healingDisplay.amount}`, healingDisplay.x, healingDisplay.y);
        }

        function animateDamage() {
            const animationDuration = 1; // Duration of the animation in seconds
            const framesPerSecond = 60; // Assuming 60 frames per second
            const alphaDecrement = 1 / (animationDuration * framesPerSecond); // How much alpha decreases each frame
            const positionDecrement = 1; // How much position decreases each frame

            if (damageDisplay.enemy.alpha > 0) {
                damageDisplay.enemy.y -= positionDecrement;
                damageDisplay.enemy.alpha -= alphaDecrement;
            }

            if (damageDisplay.player.alpha > 0) {
                damageDisplay.player.y -= positionDecrement;
                damageDisplay.player.alpha -= alphaDecrement;
            }

            if (healingDisplay.alpha > 0) {
                healingDisplay.y -= positionDecrement;
                healingDisplay.alpha -= alphaDecrement;
            }

            drawGame();
            if (damageDisplay.enemy.alpha > 0 || damageDisplay.player.alpha > 0 || healingDisplay.alpha > 0) {
                requestAnimationFrame(animateDamage);
            }
        }

        function resetDamageDisplay() {
            damageDisplay = {
                player: { damage: 0, x: 0, y: 0, alpha: 0 },
                enemy: { damage: 0, x: 0, y: 0, alpha: 0 }
            };

            healingDisplay = {
                amount: 0,
                x: 0,
                y: 0,
                alpha: 0
            };
        }

        function resetGame() {
    player.health = player.maxHealth;
    player.experience = 0;
    player.gold = 0;
    player.expBooster = false;
    player.defending = false;
    player.specialAttackCooldown = 0;
    player.poisonCounter = 0;
    player.burnedTurns = 0;
    player.blind = 0;
    player.shieldOfLight = 0;
    player.parry = false;

    enemies = createEnemies(player.level);
    gameState = 'playerTurn';

    hideDefeatScreen();
    
    const gameContainer = document.getElementById('gameContainer');
    gameContainer.style.display = 'flex';
    
    canvas.style.display = 'block';
    const gameButtons = document.getElementById('gameButtons');
    gameButtons.style.display = 'flex';
    gameButtons.style.justifyContent = 'center';
    gameButtons.style.width = '100%';

    // Reset button states
    updateButtonStates();

    drawGame();
    animateDamage();
}

        //function developerReset() {
         //   player.health = player.maxHealth; // Reset player's health to max
        //    player.defending = false; // Reset defending state
        //    player.specialAttackCooldown = 0; // Reset special attack cooldown

        //    enemies = createEnemies(player.level); // Create new enemies for the player to battle

         //   gameState = 'playerTurn'; // Set game state to player turn

        //    drawGame(); // Redraw the game state
         //   animateDamage(); // Start damage animation
        //}

        function showPlayerTurnNotification() {
            if (gameState !== 'victory' && gameState !== 'defeat') {
                const notificationElement = document.getElementById('notificationText');
                notificationElement.textContent = 'Player Turn';
                setTimeout(() => {
                    if (gameState !== 'victory' && gameState !== 'defeat') {
                        notificationElement.textContent = '';
                    }
                }, 1000);
            }
        }

        function showEnemyTurnNotification() {
            if (gameState !== 'victory' && gameState !== 'defeat') {
                const notificationElement = document.getElementById('notificationText');
                notificationElement.textContent = 'Enemy Turn';
                setTimeout(() => {
                    if (gameState !== 'victory' && gameState !== 'defeat') {
                        notificationElement.textContent = '';
                    }
                }, 1000);
            }
        }

        function playerAttack() {
    if (gameState === 'playerTurn') {
        showPlayerTurnNotification();
        //updateButtonStates();
        
        if (player.specialAttackCooldown > 0) {
            player.specialAttackCooldown--;
            console.log("Special attack cooldown decreased to:", player.specialAttackCooldown);
        }

        let damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage;
        
        if (enemies[selectedEnemyIndex].parryNextAttack) {
            console.log("Enemy parried the attack!");
            damageDisplay.player.damage = damage;
            damageDisplay.player.x = 75;
            damageDisplay.player.y = 150;
            damageDisplay.player.alpha = 1;
            player.health -= damage;
            enemies[selectedEnemyIndex].parryNextAttack = false;
            damage = 0;
        } else {
            if (enemies[selectedEnemyIndex].exposed) {
                damage *= 2;
                enemies[selectedEnemyIndex].exposed = false;
            }
            
            if (enemies[selectedEnemyIndex].defending) {
                damage = Math.floor(damage / 2);
                enemies[selectedEnemyIndex].defending = false;
            }

            enemies[selectedEnemyIndex].health -= damage;

            damageDisplay.enemy.damage = damage;
            damageDisplay.enemy.x = 725;
            damageDisplay.enemy.y = 150 + (selectedEnemyIndex * 130);
            damageDisplay.enemy.alpha = 1;
        }

        
        // Apply poison damage to the enemy at the end of player's turn
        if (enemies[selectedEnemyIndex].poisonCounter > 0) {
            const poisonDamage = enemies[selectedEnemyIndex].poisonCounter;
            enemies[selectedEnemyIndex].health -= poisonDamage;
            console.log(`Enemy takes ${poisonDamage} poison damage`);
            enemies[selectedEnemyIndex].poisonCounter++;
        }
        applyPoisonDamage(); // Apply poison damage at the end of the turn
        checkEnemyDefeat();

        if (gameState !== 'victory' && gameState !== 'duelVictory') {
            gameState = 'enemyTurn';
            updateButtonStates();
            drawGame();
            animateDamage();
            setTimeout(() => {
                handleEnemyTurn();
            }, 500);
        }
    }
}
  
        function playerSpecialAttack() {
    console.log("playerSpecialAttack function called");
    console.log("Current game state:", gameState);
    console.log("Special attack cooldown:", player.specialAttackCooldown);
    console.log("Player special skill:", player.specialSkill);

    if (gameState === 'playerTurn' && player.specialSkill && player.specialAttackCooldown === 0) {
        showPlayerTurnNotification();

        if (typeof player.specialSkill.use !== 'function') {
            console.error("Special skill 'use' is not a function!", player.specialSkill);
            return;
        }

        console.log("Using special skill:", player.specialSkill.name);
        const totalDamage = player.specialSkill.use();
        console.log("Damage dealt:", totalDamage);

        // Apply the damage to the enemy
        enemies[selectedEnemyIndex].health -= totalDamage;
        
        // Update damage display
        damageDisplay.enemy.damage = totalDamage;
        damageDisplay.enemy.x = 725;
        damageDisplay.enemy.y = 150;
        damageDisplay.enemy.alpha = 1;

        player.specialAttackCooldown = 3; // Set cooldown after using the skill
        console.log("Set special attack cooldown to:", player.specialAttackCooldown);
        applyPoisonDamage(); // Apply poison damage at the end of the turn
        checkEnemyDefeat();

        if (gameState !== 'victory') {
            gameState = 'enemyTurn';
            updateButtonStates();
            drawGame();
            animateDamage();
            setTimeout(() => {
                handleEnemyTurn();
            }, 500);
        }
    } else {
        console.log("Cannot use special attack now");
        if (player.specialAttackCooldown > 0) {
            console.log("Special attack on cooldown:", player.specialAttackCooldown);
        }
        if (!player.specialSkill) {
            console.log("Player does not have a special skill");
        }
    }
}

        function checkEnemyDefeat() {
    if (enemies[selectedEnemyIndex].health <= 0) {
        let defeatedEnemyXP = 0;
        if (enemies[selectedEnemyIndex].class) {  // Check for .class property to identify duel enemies
            // This is a duel enemy
            defeatedEnemyXP = 20; // Set a fixed XP for duel enemies, or calculate based on level
        } else {
            // This is a regular enemy
            const enemyType = enemyTypes.find(type => type.type === enemies[selectedEnemyIndex].type);
            defeatedEnemyXP = enemyType ? enemyType.xp : 0;
        }
        currentBattleExpGained += defeatedEnemyXP;
        enemies.splice(selectedEnemyIndex, 1);
        resetDamageDisplay();
        selectedEnemyIndex = 0;
        if (enemies.length === 0) {
            if (enemies[0] && enemies[0].class) {  // Check if it was a duel
                gameState = 'duelVictory';
                clearNotification();
                showDuelVictoryScreen();
            } else {
                gameState = 'victory';
                clearNotification();
                showVictoryScreen(currentBattleExpGained > defeatedEnemyXP); // Pass true if it was a double battle
            }
        }
    }
}

        function playerDefend() {
  
  if (player.specialAttackCooldown > 0) {
            player.specialAttackCooldown--;
            console.log("Special attack cooldown decreased to:", player.specialAttackCooldown);
        }
    if (gameState !== 'victory' && gameState !== 'duelVictory') {
        player.defending = true;
        //
        applyPoisonDamage(); // Apply poison damage at the end of the turn
        gameState = 'enemyTurn';
        showPlayerTurnNotification();
        updateButtonStates();
        drawGame();
        setTimeout(() => {
            handleEnemyTurn();
        }, 500);
    }
}

        function playerRetreat() {
    console.log("Player attempting to retreat");
     if (confirm("Are you sure you want to retreat? You will take damage from all enemies.")){
    showPlayerTurnNotification();

    // Calculate total damage from all enemies
    let totalDamage = 0;
    enemies.forEach(enemy => {
        let damage = Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage;
        totalDamage += damage;
    });

    // Apply damage to player
    player.health -= totalDamage;

    // Display retreat damage
    damageDisplay.player.damage = totalDamage;
    damageDisplay.player.x = 75;
    damageDisplay.player.y = 150;
    damageDisplay.player.alpha = 1;

    // Animate the damage
    drawGame();
    animateDamage();

    // Check if player survived the retreat
    setTimeout(() => {
        if (player.health <= 0) {
            console.log("Player died while retreating");
            gameState = 'defeat';
            showDefeatScreen();
        } else {
            console.log("Player successfully retreated");
            // Reset any battle-specific states here if needed
            player.defending = false;
            player.parry = false;
            player.burnedTurns = 0;
            player.poisonCounter = 0;
            player.blind = 0;
            player.shieldOfLight = 0;

            // Return to camp
            showCampScreen();
        }
    }, 500); // Wait for 1 second to show the damage before proceeding
  }
}

        function handleEnemyTurn() {
    showEnemyTurnNotification();
    updateButtonStates();
    const attackEnemies = (index) => {
        if (index >= enemies.length) {
            gameState = 'playerTurn';
            updateButtonStates();
            drawGame();
            resetDamageDisplay();
            return;
        }

        setTimeout(() => {
            let enemy = enemies[index];

            if (enemy.stunnedTurns > 0) {
                enemy.stunnedTurns--;
                attackEnemies(index + 1);
                return;
            }

            let damage = Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage;

            if (enemy.type === 'Poisonous Plant') {
    console.log("Poisonous Plant attack");
    if (Math.random() < 0.25) {
        console.log("Poisonous Plant poison attempt");
        if (!player.poisonCounter || player.poisonCounter === 0) {
            player.poisonCounter = 1;
            console.log("Player has been poisoned!");
            alert("You've been poisoned by the Poisonous Plant!");
        } else {
            console.log("Player already poisoned, poisonCounter:", player.poisonCounter);
        }
    } else {
        console.log("Poisonous Plant regular attack");
    }
}

            if (player.blind) {
                if (Math.random() * 100 < player.blind) {
                    damage = 0;
                    console.log("Enemy attack missed due to blindness");
                }
                player.blind = Math.max(0, player.blind - 25);
            }

            if (player.parry) {
                damageDisplay.enemy.damage = damage;
                damageDisplay.enemy.x = 725;
                damageDisplay.enemy.y = 150 + (index * 130);
                damageDisplay.enemy.alpha = 1;
                enemy.health -= damage;
                player.parry = false;
                damage = 0;
                console.log("Player parried the attack");
            } else if (player.defending) {
                damage = Math.floor(damage / 2);
                player.defending = false;
            } else if (player.shieldOfLight > 0) {
                damage = Math.max(0, damage - 6);
                player.shieldOfLight--;
                if (player.shieldOfLight === 0) {
                    player.maxDamage -= 2;
                    player.health = Math.min(player.health + 6, player.maxHealth);
                }
            }

            player.health -= damage;

            damageDisplay.player.damage = damage;
            damageDisplay.player.x = 75;
            damageDisplay.player.y = 150 + (index * 30);
            damageDisplay.player.alpha = 1;

            // Apply conditional damage to player
            if (player.burnedTurns > 0) {
                const burnDamage = Math.floor(Math.random() * 4) + 1;
                player.health -= burnDamage;
                console.log(`Player took ${burnDamage} burn damage`);
                player.burnedTurns--;
            }

            

            // Apply conditional damage after the enemy attacks
            let conditionalDamage = 0;

            if (enemy.burnedTurns > 0) {
                const burnDamage = Math.floor(Math.random() * 4) + 1;
                enemy.health -= burnDamage;
                damageDisplay.enemy.damage = burnDamage;
                damageDisplay.enemy.x = 725;
                damageDisplay.enemy.y = 150 + (index * 130);
                damageDisplay.enemy.alpha = 1;

                enemy.burnedTurns--;
            }

            if (enemy.poison) {
                const poisonDamage = enemy.poison;
                enemy.health -= poisonDamage;
                damageDisplay.enemy.damage = poisonDamage;
                damageDisplay.enemy.x = 725;
                damageDisplay.enemy.y = 150 + (index * 130);
                damageDisplay.enemy.alpha = 1;
            }

            if (conditionalDamage > 0) {
                damageDisplay.enemy.damage = conditionalDamage;
                damageDisplay.enemy.x = 725;
                damageDisplay.enemy.y = 150 + (index * 130);
                damageDisplay.enemy.alpha = 1;
            }

            if (enemy.health <= 0) {
                const defeatedEnemyXP = enemyTypes.find(type => type.type === enemy.type).xp;
                currentBattleExpGained += defeatedEnemyXP;
                enemies.splice(index, 1);
                if (enemies.length === 0) {
                    gameState = 'victory';
                    clearNotification();
                    showVictoryScreen();
                    return;
                }
            }

            if (player.health <= 0) {
                gameState = 'defeat';
                clearNotification();
                animateDamage();
                setTimeout(() => {
                    showDefeatScreen();
                }, 1000);
                return;
            }
            drawGame();
            animateDamage();
            setTimeout(() => {
                // Move to the next enemy, or end the turn if all enemies have acted
                attackEnemies(index + 1);
            }, 500);
        }, 500);
    };

    attackEnemies(0);
}

        function checkVictory() {
            if (enemies.length === 0) {
                gameState = 'victory';
                clearNotification();
                showVictoryScreen();
            }
        }

        function showVictoryScreen(isDoubleBattle = false) {
    let goldEarned = Math.floor(Math.random() * 201) + 100;
    // Reset purchases for the new victory screen visit
    currentVictoryScreenPurchases = {};
    
    // Add extra gold for double battle
    if (isDoubleBattle) {
        goldEarned += 100;
    }

    player.gold += goldEarned;

    let totalExpGained = currentBattleExpGained;
    if (player.expBooster) {
        totalExpGained *= 2;
        player.expBooster = false;
    }
    player.experience += totalExpGained;
    victoryExpGained = totalExpGained;

    if (player.experience >= player.xpToNextLevel) {
        checkBattleLevelUp();
    }

    let victoryMessage = `You earned ${victoryExpGained} XP for winning this battle.<br>`;
    if (victoryLevelUpMessage) {
        victoryMessage += `${victoryLevelUpMessage}<br>`;
        victoryLevelUpMessage = '';
    }
    victoryMessage += `Current Stats:<br>
    Health: ${player.health}/${player.maxHealth}<br>
    Min Damage: ${player.minDamage}<br>
    Max Damage: ${player.maxDamage}<br>
    XP: ${player.experience}/${player.xpToNextLevel}`;

    const goldMessage = `You earned ${goldEarned} gold.<br>Current Gold: ${player.gold}<br><br>Camp Bank: ${player.campBank} Gold`;
    document.getElementById('victoryMessage').innerHTML = victoryMessage;
    document.getElementById('goldMessage').innerHTML = goldMessage;

    updateShopButtons(true);

    // Set up event listeners for navigation buttons
    document.getElementById('continueJourneyButton').onclick = continueJourney;
    document.getElementById('returnToCampButton').onclick = returnToCamp;
    document.getElementById('developerGoldButton').onclick = () => {
        player.gold += 1500;
        updateGoldMessage();
        updateVictoryScreenStats();
        alert("Added 1500 gold to the player!");
    };

    // Show/hide elements
    canvas.style.display = 'none';
    document.getElementById('gameButtons').style.display = 'none';
    document.getElementById('gameVictoryScreen').style.display = 'block';

    // Check for skill selection
    if (player.level >= 3 && !player.specialSkill) {
        document.getElementById('skillSelection').style.display = 'block';
        document.getElementById('continueJourneyButton').style.display = 'none';
        document.getElementById('returnToCampButton').style.display = 'none';
        showBattleSkillSelection();
    } else {
        document.getElementById('skillSelection').style.display = 'none';
        document.getElementById('continueJourneyButton').style.display = 'inline-block';
        document.getElementById('returnToCampButton').style.display = 'inline-block';
    }

    currentBattleExpGained = 0;
    resetDamageDisplay();
    autoSave();
    resetPurchasedItems();
    updateLoadGameButton();
    ensureButtonVisibility();
}
        
        function hideVictoryScreen() {
            document.getElementById('gameVictoryScreen').style.display = 'none';
            document.getElementById('gameVictoryScreen').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'none';
        }
        

        function showDefeatScreen() {
    canvas.style.display = 'none';
    document.getElementById('gameButtons').style.display = 'none';
    

    // Reset all player status conditions
    player.poisonCounter = 0;
    player.burnedTurns = 0;
    player.blind = 0;
    player.shieldOfLight = 0;
    player.parry = false;
    player.defending = false;

    const defeatScreen = document.getElementById('gameDefeatScreen');
    defeatScreen.style.display = 'block';
    resetDamageDisplay();
    autoSave();
    updateLoadGameButton();
}

        function hideDefeatScreen() {
            const defeatScreen = document.getElementById('gameDefeatScreen');
            defeatScreen.style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('gameButtons').style.display = 'block';
        }

        function continueJourney() {
    console.log("Entering continueJourney function");
    hideVictoryScreen();
    hideStoryEventScreen();
    hideCampScreen();
    
    
    const eventType = getEventType();
    console.log("Event type selected:", eventType);
    
    switch(eventType) {
        case 'duel':
            console.log("Starting duel event");
            startDuelEvent();
            break;
        case 'story':
            console.log("Starting story event");
            if (Math.random() <= 0.5) {
                showStoryEvent1();
            } else {
                showStoryEvent2();
            }
            break;
        case 'battle':
            console.log("Starting battle");
            startBattle(); // Use startBattle without specifying a class
            break;
    }
}

        function returnToCamp() {
            hideVictoryScreen();
            document.getElementById('storyLevelUpMessage').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'none';
            showCampScreen();
        }

        function showCampScreen() {
    hideDuelEventScreen();
    hideVictoryScreen();
    hideStoryEventScreen();
    canvas.style.display = 'none';
    document.getElementById('gameButtons').style.display = 'none';
    
    const campScreen = document.getElementById('campScreen');
    campScreen.style.display = 'block';
    document.getElementById('storeGoldButton').onclick = storeGoldInCamp;
    
    updatePlayerTents();
    updateCommercialTents();
    
    // Update merchant tent button visibility
    const merchantTentButton = document.getElementById('merchantTentButton');
    if (merchantTentButton) {
        merchantTentButton.style.display = player.merchantTent ? 'none' : 'block';
    }
    
    // Ensure the continue journey button is visible
    document.getElementById('continueJourneyFromCampButton').style.display = 'block';
    
    // Move camp shop above continue journey button
    const campShop = document.getElementById('campShop');
    const continueButton = document.getElementById('continueJourneyFromCampButton');
    if (campShop && continueButton) {
        continueButton.parentNode.insertBefore(campShop, continueButton);
    }
    
    if (player.merchantTent) {
        showShopInCamp();
    }
    
    updateCampMessage();
    updateTentButtons();
    updateCampShopButtons();
}

        function updateVictoryShopButtons() {
    updateShopButtons(true);
}

       
        function updateCampShopButtons() {
    const buttons = [
        { id: 'campHealingPotionButton', item: 'healingPotion', cost: 100, name: 'Healing Potion', description: 'Heal 25 HP' },
        { id: 'campExpBoosterButton', item: 'expBooster', cost: 200, name: 'EXP Booster', description: 'Double the next XP gained' },
        { id: 'campAntidoteButton', item: 'antidote', cost: 300, name: 'Antidote', description: 'Heals poison' },
        { id: 'campLotusButton', item: 'lotus', cost: 500, name: 'Lotus of Experience', description: 'Grants 10 XP' },
        { id: 'campRedPillButton', item: 'redPill', cost: 1000, name: 'Red Pill', description: '+1 Min Damage' }
    ];

    buttons.forEach(button => {
        const element = document.getElementById(button.id);
        if (element) {
            if (player.purchasedItems[button.item]) {
                element.disabled = true;
                element.innerHTML = '<div class="button-content"><span class="item-name">Sold Out</span></div>';
            } else {
                element.disabled = false;
                element.innerHTML = `
                    <div class="button-content">
                        <span class="item-name">Buy ${button.name}</span>
                        <span class="gold-amount">${button.cost} Gold</span>
                    </div>
                `;
                element.onclick = () => buyItemInCamp(button.item, button.cost, button.name);
            }
        }
    });
}
        
        function updatePlayerTents() {
            const playerTentsRow = document.getElementById('playerTentsRow');
            playerTentsRow.innerHTML = ''; // Clear existing tents
            
            for (let i = 0; i < player.tents; i++) {
                const tentSquare = createTentSquare(i === 0 ? 'Player Tent' : `Tent ${i + 1}`);
                playerTentsRow.appendChild(tentSquare);
            }
        }
        
        function updateCommercialTents() {
            const commercialTentsRow = document.getElementById('commercialTentsRow');
            commercialTentsRow.innerHTML = ''; // Clear existing tents
            
            if (player.merchantTent) {
                const merchantTentSquare = createTentSquare('Merchant Tent');
                commercialTentsRow.appendChild(merchantTentSquare);
            }
        }
        
        function createTentSquare(text) {
            const tentSquare = document.createElement('div');
            tentSquare.className = 'tentSquare';
            tentSquare.textContent = text;
            return tentSquare;
        }
        
        function buyMerchantTent() {
            if (player.campBank >= 1000) {
                player.campBank -= 1000;
                player.merchantTent = true;
                const merchantTentButton = document.getElementById('merchantTentButton');
                if (merchantTentButton) {
                    merchantTentButton.style.display = 'none';
                }
                showCampScreen(); // Refresh the entire camp screen
                showShopInCamp(); // Show the shop
            } else {
                alert("Not enough gold in the Camp Bank!");
            }
        }
        
        function showShopInCamp() {
    if (player.merchantTent) {
        const existingShop = document.getElementById('campShop');
        if (existingShop) {
            existingShop.remove();
        }

        const shopDiv = document.createElement('div');
        shopDiv.id = 'campShop';
        shopDiv.innerHTML = `
            <h2>Merchant Shop</h2>
            <div id="campMessage" style="margin-bottom: 20px; padding: 10px; border-radius: 5px;">
                HP: ${player.health}/${player.maxHealth}<br>
                Min Damage: ${player.minDamage}<br>
                Max Damage: ${player.maxDamage}<br>
                XP: ${player.experience}/${player.xpToNextLevel}<br>
            </div>
            <div class="shop-items">
                ${createShopItem('campHealingPotionButton', 'Buy Healing Potion', 100, 'Heal 25 HP')}
                ${createShopItem('campExpBoosterButton', 'Buy EXP Booster', 200, 'Double the next XP gained')}
                ${createShopItem('campAntidoteButton', 'Buy Antidote', 300, 'Heals poison')}
                ${createShopItem('campLotusButton', 'Buy Lotus of Experience', 500, 'Grants 10 XP')}
                ${createShopItem('campRedPillButton', 'Buy Red Pill', 1000, '+1 Min Damage')}
            </div>
        `;

        const continueButton = document.getElementById('continueJourneyFromCampButton');
        continueButton.parentNode.insertBefore(shopDiv, continueButton);
        updateShopButtons(false);
        
        updateCampShopButtons();
    }
}
        
        function createShopItem(id, name, gold, description) {
    const itemKey = id.replace('camp', '').replace('Button', '').toLowerCase();
    const isPurchased = player.purchasedItems && player.purchasedItems[itemKey];
    return `
        <div class="shop-item">
            <button id="${id}" ${isPurchased ? 'disabled' : ''}>
                <div class="button-content">
                    <span class="item-name">${isPurchased ? 'Sold Out' : name}</span>
                    ${!isPurchased ? `<span class="gold-amount">${gold} Gold</span>` : ''}
                </div>
            </button>
            <span class="item-description">${description}</span>
        </div>
    `;
}
        
        function buyVictoryItem(item, cost, itemName) {
            if (player.gold < cost) {
                alert("Not enough gold!");
                return;
            }
        
            if (currentVictoryScreenPurchases[item]) {
                alert("You've already purchased this item in this visit!");
                return;
            }
        
            switch(item) {
                case 'healingPotion':
                    if (player.health >= player.maxHealth) {
                        alert("Your HP is full!");
                        return;
                    }
                    break;
                case 'antidote':
                    if (player.poisonCounter === 0) {
                        alert("You are not poisoned!");
                        return;
                    }
                    break;
            }
        
            player.gold -= cost;
            
            // Mark the item as purchased for this victory screen visit
            currentVictoryScreenPurchases[item] = true;
        
            applyItemEffect(item);
            updateGoldMessage();
            updateVictoryScreenStats();
            updateShopButtons(true);  // Update the buttons after purchase
            alert(`You bought ${itemName} for ${cost} gold.`);
      }

        function resetPurchasedItems() {
            player.purchasedItems = {
                healingPotion: false,
                expBooster: false,
                antidote: false,
                lotus: false,
                redPill: false
            };
        }
        
        function updateCampMessage() {
            const campMessageElement = document.getElementById('campMessage');
            if (campMessageElement) {
                campMessageElement.innerHTML = `
                    Current Gold: ${player.gold}<br>
                    Camp Bank: ${player.campBank} Gold<br>
                    Tents: ${player.tents}<br>
                    HP: ${player.health}/${player.maxHealth}
                `;
            }
        }
        
        function updateTentButtons() {
            console.log("Updating tent buttons. Player tents:", player.tents);
            const tentCosts = [1500, 2000, 2500, 3000];
            for (let i = 2; i <= 5; i++) {
                const button = document.getElementById(`${getTentNumberWord(i)}TentButton`);
                if (i === player.tents + 1) {
                    button.style.display = 'block';
                    button.disabled = player.campBank < tentCosts[i - 2];
                } else {
                    button.style.display = 'none';
                }
            }
        }

        function getEventType() {
            const eventRoll = Math.random();
            
            if (duelEventsUnlocked) {
                // Duel events unlocked
                if (eventRoll < 0.70) {
                    return 'battle';
                } else if (eventRoll < 0.85) {
                    return 'story';
                } else {
                    return 'duel';
                }
            } else {
                // Duel events locked
                if (eventRoll < 0.85) {
                    return 'battle';
                } else {
                    return 'story';
                }
            }
        }
    
        function hideCampScreen() {
			document.getElementById('campScreen').style.display = 'none';
			document.getElementById('gameVictoryScreen').style.display = 'none';
      document.getElementById('gameButtons').style.display = 'none';
      document.getElementById('gameCanvas').style.display = 'none';
		}

        function storeGoldInCamp() {
            player.campBank += player.gold;
            player.gold = 0;
            updateCampMessage();
            updateTentButtons();
        }

        function hideVictoryScreen() {
			document.getElementById('gameVictoryScreen').style.display = 'none';
			document.getElementById('gameVictoryScreen').style.display = 'none';
      document.getElementById('gameButtons').style.display = 'none';
      document.getElementById('gameCanvas').style.display = 'none';
		}
		
		    function removeAllEventListeners(element) {
    const newElement = element.cloneNode(true);
    element.parentNode.replaceChild(newElement, element);
    return newElement;
}

        function updateVictoryShopButtons() {
    const buttons = [
        { id: 'healingPotionButton', item: 'healingPotion', cost: 100, name: 'Healing Potion', description: 'Heal 25 HP' },
        { id: 'expBoosterButton', item: 'expBooster', cost: 200, name: 'EXP Booster', description: 'Double the next XP gained' },
        { id: 'antidoteButton', item: 'antidote', cost: 300, name: 'Antidote', description: 'Heals poison' },
        { id: 'lotusButton', item: 'lotus', cost: 500, name: 'Lotus of Experience', description: 'Grants 10 XP' },
        { id: 'redPillButton', item: 'redPill', cost: 1000, name: 'Red Pill', description: '+1 Min Damage' }
    ];

    buttons.forEach(button => {
        const element = document.getElementById(button.id);
        if (element) {
            if (player.purchasedItems[button.item]) {
                element.disabled = true;
                element.innerHTML = '<div class="button-content"><span class="item-name">Sold Out</span></div>';
            } else {
                element.disabled = false;
                element.innerHTML = `
                    <div class="button-content">
                        <span class="item-name">Buy ${button.name}</span>
                        <span class="gold-amount">${button.cost} Gold</span>
                    </div>
                `;
                element.onclick = () => buyVictoryItem(button.item, button.cost, button.name);
            }
        }
    });
}

        function updateCampShopButtons() {
    const buttons = [
        { id: 'campHealingPotionButton', item: 'healingPotion', cost: 100, name: 'Healing Potion', description: 'Heal 25 HP' },
        { id: 'campExpBoosterButton', item: 'expBooster', cost: 200, name: 'EXP Booster', description: 'Double the next XP gained' },
        { id: 'campAntidoteButton', item: 'antidote', cost: 300, name: 'Antidote', description: 'Heals poison' },
        { id: 'campLotusButton', item: 'lotus', cost: 500, name: 'Lotus of Experience', description: 'Grants 10 XP' },
        { id: 'campRedPillButton', item: 'redPill', cost: 1000, name: 'Red Pill', description: '+1 Min Damage' }
    ];

    buttons.forEach(button => {
        const element = document.getElementById(button.id);
        if (element) {
            if (player.purchasedItems[button.item]) {
                element.disabled = true;
                element.innerHTML = '<div class="button-content"><span class="item-name">Sold Out</span></div>';
            } else {
                element.disabled = false;
                element.innerHTML = `
                    <div class="button-content">
                        <span class="item-name">Buy ${button.name}</span>
                        <span class="gold-amount">${button.cost} Gold</span>
                    </div>
                `;
                element.onclick = () => buyItemInCamp(button.item, button.cost, button.name);
            }
        }
    });
}

        function buyItemInCamp(item, cost, itemName) {
    if (player.gold < cost) {
        alert("Not enough gold!");
        return;
    }

    if (player.purchasedItems[item]) {
        alert("You've already purchased this item!");
        return;
    }

    switch(item) {
        case 'healingPotion':
            if (player.health >= player.maxHealth) {
                alert("Your HP is full!");
                return;
            }
            break;
        case 'antidote':
            if (player.poisonCounter === 0) {
                alert("You are not poisoned!");
                return;
            }
            break;
    }

    player.gold -= cost;
    player.purchasedItems[item] = true;
    applyItemEffect(item);
    updateCampMessage();
    showShopInCamp();
    alert(`You bought ${itemName} for ${cost} gold.`);
}
        
        function applyItemEffect(item) {
            switch(item) {
                case 'healingPotion':
                    player.health = Math.min(player.health + 25, player.maxHealth);
                    break;
                case 'expBooster':
                    player.expBooster = true;
                    break;
                case 'antidote':
                    player.poisonCounter = 0;
                    break;
                case 'lotus':
                    player.experience += 10;
                    checkBattleLevelUp();
                    break;
                case 'redPill':
                    player.minDamage += 1;
                    break;
            }
        }
        
        function buyHealingPotion() {
            buyItem('Healing Potion', 100, () => {
                player.health = Math.min(player.health + 25, player.maxHealth);
            });
        }
        
        function buyExpBooster() {
            buyItem('EXP Booster', 200, () => {
                player.expBooster = true;
            });
        }
        
        function buyAntidote() {
            buyItem('Antidote', 300, () => {
                player.poisonCounter = 0;
            });
        }
        
        function buyLotusOfExperience() {
            buyItem('Lotus of Experience', 500, () => {
                player.experience += 10;
                checkBattleLevelUp();
            });
        }
        
        function buyRedPill() {
            buyItem('Red Pill', 1000, () => {
                player.minDamage += 1;
            });
        }

        function checkStoryLevelUp() {
    let leveledUp = false;
    while (player.experience >= player.xpToNextLevel) {
        leveledUp = true;
        player.level++;
        player.experience -= player.xpToNextLevel;
        player.xpToNextLevel += 20;

        player.healthGain = Math.floor(Math.random() * 5) + 3;
        player.maxHealth += player.healthGain;
        player.health = player.maxHealth;

        player.minDamageGain = 0;
        player.maxDamageGain = 0;
        if (Math.random() <= 0.25) {
            player.minDamage += 1;
            player.minDamageGain = 1;
        }

        const maxDamageIncreaseRoll = Math.random() * 100;
        if (maxDamageIncreaseRoll <= 60) {
            player.maxDamage += 1;
            player.maxDamageGain = 1;
        } else if (maxDamageIncreaseRoll <= 90) {
            player.maxDamage += 2;
            player.maxDamageGain = 2;
        } else {
            player.maxDamage += 3;
            player.maxDamageGain = 3;
        }

        let levelUpMessage = `You leveled up! Gained ${player.healthGain} health, +${player.minDamageGain} min damage, +${player.maxDamageGain} max damage.`;

        // Show special skill selection when reaching level 3
        if (player.level === 3 && !player.specialSkillUnlocked) {
            console.log("Triggering skill selection for " + player.class);
            player.specialSkillUnlocked = true;
            showStorySkillSelection();
            updateStoryScreenStats();
            showLevelUpMessage(levelUpMessage);
            return; // Exit the function to prevent further level-ups until skill is chosen
        }

        updateStoryScreenStats();
        showLevelUpMessage(levelUpMessage);
    }
    
    if (leveledUp && player.level >= 3 && player.specialSkill) {
        showFinalContinueButton(); // Only show continue button if a skill has been selected
    }
}

        function checkBattleLevelUp() {
    let leveledUp = false;
    while (player.experience >= player.xpToNextLevel) {
        leveledUp = true;
        player.level++;
        player.experience -= player.xpToNextLevel;
        player.xpToNextLevel += 20;

        player.healthGain = Math.floor(Math.random() * 5) + 3;
        player.maxHealth += player.healthGain;
        player.health = player.maxHealth;

        player.minDamageGain = 0;
        player.maxDamageGain = 0;
        if (Math.random() <= 0.25) {
            player.minDamage += 1;
            player.minDamageGain = 1;
        }

        const maxDamageIncreaseRoll = Math.random() * 100;
        if (maxDamageIncreaseRoll <= 60) {
            player.maxDamage += 1;
            player.maxDamageGain = 1;
        } else if (maxDamageIncreaseRoll <= 90) {
            player.maxDamage += 2;
            player.maxDamageGain = 2;
        } else {
            player.maxDamage += 3;
            player.maxDamageGain = 3;
        }

        let levelUpMessage = `You leveled up! Gained ${player.healthGain} health, +${player.minDamageGain} min damage, +${player.maxDamageGain} max damage.`;
        victoryLevelUpMessage += levelUpMessage + '<br>';

        // Show special skill selection when reaching level 3
        if (player.level === 3 && !player.specialSkillUnlocked) {
            console.log("Triggering skill selection for " + player.class);
            player.specialSkillUnlocked = true;
            showBattleSkillSelection();
            break; // Exit the loop after showing skill selection
        }
    }
    return leveledUp;
}

        function updateGoldMessage() {
            document.getElementById('goldMessage').innerHTML = `Current Gold: ${player.gold}<br><br>Camp Bank: ${player.campBank} Gold`;
        }

        function updateVictoryScreenStats() {
            let victoryMessage = `You earned ${victoryExpGained} XP for winning this battle.<br>`;

            if (victoryLevelUpMessage) {
                victoryMessage += `${victoryLevelUpMessage}<br>`;
            }

            victoryMessage += `Current Stats:<br>
            Health: ${player.health}/${player.maxHealth}<br>
            Min Damage: ${player.minDamage}<br>
            Max Damage: ${player.maxDamage}<br>
            XP: ${player.experience}/${player.xpToNextLevel}`;

            document.getElementById('victoryMessage').innerHTML = victoryMessage;
            document.getElementById('goldMessage').innerHTML = `Current Gold: ${player.gold}<br><br>Camp Bank: ${player.campBank} Gold`;
        }

        function clearNotification() {
            const notificationElement = document.getElementById('notificationText');
            notificationElement.textContent = '';
        }

        function showStoryEvent1() {
            console.log("Entering showStoryEvent1");
            inStoryEvent = true;
            ensureButtonVisibility();
            currentStory = STORY_OLD_MAN;
            document.getElementById('storyLevelUpMessage').style.display = 'none';
            document.getElementById('storyLevelUpMessage').innerHTML = '';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'none';
            document.getElementById('storyEventScreen').style.display = 'block';
            document.getElementById('storyText').innerHTML = "You encounter an old man on the road. He asks if you can spare 100 gold for some food and a warm bed.";

            document.getElementById('storyChoice1Button').textContent = "Give the old man 100 gold";
            document.getElementById('storyChoice2Button').textContent = "Ask what he is doing on the road";
            document.getElementById('storyChoice3Button').textContent = "Ignore him and keep walking";

            // Remove previous event listeners before adding new ones
            removeEventListeners('storyChoice1Button', 'storyChoice2Button', 'storyChoice3Button');

            document.getElementById('storyChoice1Button').addEventListener('click', handleOldManChoice1);
            document.getElementById('storyChoice2Button').addEventListener('click', handleOldManChoice2);
            document.getElementById('storyChoice3Button').addEventListener('click', handleOldManChoice3);

            document.getElementById('storyChoices').style.display = 'block';
            document.getElementById('continueJourneyFromStoryButton').style.display = 'none';
            document.getElementById('continueToBattleButton').style.display = 'none'; // Ensure the button is hidden initially
            document.getElementById('storyStats').style.display = 'none'; // Hide stats initially
        }

        function handleOldManChoice1() {
            console.log("Executing handleOldManChoice1");
            if (currentStory !== STORY_OLD_MAN) return;
            if (player.gold >= 100) {
                player.gold -= 100;
                player.minDamage += 1;
                player.maxDamage += 1;
                let xpGained = player.expBooster ? 20 : 10; // Double XP if booster is active
                player.experience += xpGained;
                document.getElementById('storyText').innerHTML = `The old man teaches you to be a better fighter. You gain +1 min damage, +1 max damage, and ${xpGained} XP.`;
                checkStoryLevelUp();
                player.expBooster = false; // Reset the XP booster after use

                // Show level-up message if player leveled up
                if (player.experience >= player.xpToNextLevel) {
                    showLevelUpMessage();
                }
            } else {
                document.getElementById('storyText').innerHTML = "You don't have enough gold to give.";
            }
            showFinalContinueButton(); // Show final continue button and update stats
        }

        function handleOldManChoice2() {
            console.log("Executing handleOldManChoice2");
            if (currentStory !== STORY_OLD_MAN) return;
            document.getElementById('storyText').innerHTML = "The old man explains that he is going to visit his family but since age has caught up to him, the trip is slow and he has exhausted all the gold he had.";

            document.getElementById('storyChoice1Button').textContent = "Give him 100 gold";
            document.getElementById('storyChoice2Button').textContent = "Give him 200 gold";
            document.getElementById('storyChoice3Button').textContent = "Walk away and continue the journey";

            // Remove previous event listeners before adding new ones
            removeEventListeners('storyChoice1Button', 'storyChoice2Button', 'storyChoice3Button');

            document.getElementById('storyChoice1Button').addEventListener('click', handleOldManChoice1_2);
            document.getElementById('storyChoice2Button').addEventListener('click', handleOldManChoice2_2);
            document.getElementById('storyChoice3Button').addEventListener('click', handleOldManChoice3_2);

            document.getElementById('storyChoices').style.display = 'block';
        }

        function handleOldManChoice1_2() {
            console.log("Executing handleOldManChoice1_2");
            if (currentStory !== STORY_OLD_MAN) return;
            if (player.gold >= 100) {
                player.gold -= 100;
                player.minDamage += 1;
                player.maxDamage += 1;
                let xpGained = player.expBooster ? 20 : 10; // Double XP if booster is active
                player.experience += xpGained;
                document.getElementById('storyText').innerHTML = `The old man teaches you to be a better fighter. You gain +1 min damage, +1 max damage, and ${xpGained} XP.`;
                checkStoryLevelUp();
                player.expBooster = false; // Reset the XP booster after use

                // Show level-up message if player leveled up
                if (player.experience >= player.xpToNextLevel) {
                    showLevelUpMessage();
                }
            } else {
                document.getElementById('storyText').innerHTML = "You don't have enough gold to give.";
            }
            showFinalContinueButton(); // Show final continue button and update stats
        }

        function handleOldManChoice2_2() {
            console.log("Executing handleOldManChoice2_2");
            if (currentStory !== STORY_OLD_MAN) return;
            if (player.gold >= 200) {
                player.gold -= 200;
                player.minDamage += 1;
                player.maxDamage += 2;
                let xpGained = player.expBooster ? 20 : 10; // Double XP if booster is active
                player.experience += xpGained;
                document.getElementById('storyText').innerHTML = `The old man is deeply grateful and teaches you advanced combat techniques. You gain +1 min damage, +2 max damage, and ${xpGained} XP.`;
                checkStoryLevelUp();
                player.expBooster = false; // Reset the XP booster after use

                // Show level-up message if player leveled up
                if (player.experience >= player.xpToNextLevel) {
                    showLevelUpMessage();
                }
            } else {
                document.getElementById('storyText').innerHTML = "You don't have enough gold to give.";
            }
            showFinalContinueButton(); // Show final continue button and update stats
        }

        function handleOldManChoice3() {
            console.log("Executing handleOldManChoice3");
            if (currentStory !== STORY_OLD_MAN) return;
            document.getElementById('storyText').innerHTML = "You ignore the old man and keep walking.";
            showFinalContinueButton(); // Show final continue button and update stats
        }

        function handleOldManChoice3_2() {
            console.log("Executing handleOldManChoice3_2");
            if (currentStory !== STORY_OLD_MAN) return;
            document.getElementById('storyText').innerHTML = "You walk away and continue your journey.";
            showFinalContinueButton(); // Show final continue button and update stats
        }

        function showStoryEvent2() {
            console.log("Entering showStoryEvent2");
            inStoryEvent = true;
            ensureButtonVisibility();
            currentStory = STORY_TREANT;
            document.getElementById('storyLevelUpMessage').style.display = 'none';
            document.getElementById('storyLevelUpMessage').innerHTML = '';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'none';
            document.getElementById('storyEventScreen').style.display = 'block';
            document.getElementById('storyText').innerHTML = "You find a tree that seems to be murmuring to itself. You get close to the tree and have 3 options.";

            document.getElementById('storyChoice1Button').textContent = "Poke the tree with your weapon";
            document.getElementById('storyChoice2Button').textContent = "Ask if it's alright";
            document.getElementById('storyChoice3Button').textContent = "Leave right away";

            // Remove previous event listeners before adding new ones
            removeEventListeners('storyChoice1Button', 'storyChoice2Button', 'storyChoice3Button');

            document.getElementById('storyChoice1Button').addEventListener('click', handleTreePoke1);
            document.getElementById('storyChoice2Button').addEventListener('click', handleTreeAsk);
            document.getElementById('storyChoice3Button').addEventListener('click', handleTreeLeave);

            document.getElementById('storyChoices').style.display = 'block';
            document.getElementById('continueJourneyFromStoryButton').style.display = 'none';
            document.getElementById('continueToBattleButton').style.display = 'none'; // Ensure the button is hidden initially
            document.getElementById('storyStats').style.display = 'none'; // Hide stats initially
        }

        function handleTreePoke1() {
            console.log("Executing handleTreePoke1");
            if (currentStory !== STORY_TREANT) return;
            document.getElementById('storyText').innerHTML = "The tree asks why you are bothering it, as it is having trouble sleeping. It would appreciate if you could leave it alone.";

            document.getElementById('storyChoice1Button').textContent = "Poke it again";
            document.getElementById('storyChoice2Button').textContent = "Ask why it needs to sleep";
            document.getElementById('storyChoice3Button').textContent = "Walk away";

            // Remove previous event listeners before adding new ones
            removeEventListeners('storyChoice1Button', 'storyChoice2Button', 'storyChoice3Button');

            document.getElementById('storyChoice1Button').addEventListener('click', handleTreePoke2);
            document.getElementById('storyChoice2Button').addEventListener('click', handleTreeAsk2);
            document.getElementById('storyChoice3Button').addEventListener('click', handleTreeLeave);

            document.getElementById('storyChoices').style.display = 'block';
            document.getElementById('continueJourneyFromStoryButton').style.display = 'none';
            document.getElementById('continueToBattleButton').style.display = 'none';
        }

        function handleTreePoke2() {
            console.log("Executing handleTreePoke2");
            if (currentStory !== STORY_TREANT) return;
            document.getElementById('storyText').innerHTML = "The tree says it wishes to be left alone and does not want to be hurt or hurt anyone but will defend itself to rest.";

            document.getElementById('storyChoice1Button').textContent = "Poke it a third time";
            document.getElementById('storyChoice2Button').textContent = "Ask why it needs to sleep";
            document.getElementById('storyChoice3Button').textContent = "Walk away";

            // Remove previous event listeners before adding new ones
            removeEventListeners('storyChoice1Button', 'storyChoice2Button', 'storyChoice3Button');

            document.getElementById('storyChoice1Button').addEventListener('click', handleTreePoke3);
            document.getElementById('storyChoice2Button').addEventListener('click', handleTreeAsk2);
            document.getElementById('storyChoice3Button').addEventListener('click', handleTreeLeave);

            document.getElementById('storyChoices').style.display = 'block';
            document.getElementById('continueJourneyFromStoryButton').style.display = 'none';
            document.getElementById('continueToBattleButton').style.display = 'none';
        }

        function handleTreePoke3() {
            console.log("Executing handleTreePoke3");
            if (currentStory !== STORY_TREANT) return;
            document.getElementById('storyText').innerHTML = "The tree gets angry and you are thrown into a battle against the Treant!";
            document.getElementById('storyChoices').style.display = 'none';

            document.getElementById('continueToBattleButton').style.display = 'inline-block';
            document.getElementById('continueToBattleButton').onclick = function() {
                hideStoryEventScreen();
                treantEncountered = true;
                startTreantBattle();
            };
        }

        function handleTreeAsk() {
            console.log("Executing handleTreeAsk");
            if (currentStory !== STORY_TREANT) return;
            document.getElementById('storyText').innerHTML = "The tree explains that its autumn has ended and it must sleep for the winter. It thanks you for listening and hands you a fruit that heals you completely, grants +5 HP, +1 max damage, and 15 XP.";

            if (player.expBooster) {
                player.experience += 30; // Double XP if booster is active
                player.expBooster = false; // Reset the XP booster after use
            } else {
                player.experience += 15;
            }

            player.health = player.maxHealth;
            player.maxHealth += 5;
            player.maxDamage += 1;

            checkStoryLevelUp();
            updateStoryScreenStats(); // Update stats on story screen

            showFinalContinueButton(); // Show final continue button and update stats

            // Show level-up message if player leveled up
            if (player.experience >= player.xpToNextLevel) {
                showLevelUpMessage();
            }
        }

        function handleTreeAsk2() {
            console.log("Executing handleTreeAsk2");
            if (currentStory !== STORY_TREANT) return;
            document.getElementById('storyText').innerHTML = "The tree explains that its autumn has ended and it must sleep for the winter. It thanks you for listening and hands you a fruit that heals you completely, grants +5 HP, +1 max damage, and 15 XP.";
        
            if (player.expBooster) {
                player.experience += 30; // Double XP if booster is active
                player.expBooster = false; // Reset the XP booster after use
            } else {
                player.experience += 15;
            }
        
            player.health = player.maxHealth;
            player.maxHealth += 5;
            player.maxDamage += 1;
        
            checkStoryLevelUp();
            updateStoryScreenStats(); // Update stats on story screen
        
            showFinalContinueButton(); // Show final continue button and update stats
        
            // Show level-up message if player leveled up
            if (player.experience >= player.xpToNextLevel) {
                showLevelUpMessage();
            }
        }

        function handleTreeLeave() {
            console.log("Executing handleTreeLeave");
            if (currentStory !== STORY_TREANT) return;
            document.getElementById('storyText').innerHTML = "You walk away, finding the whole situation very strange.";
            showFinalContinueButton(); // Show final continue button and update stats
        }

        function showFinalContinueButton() {
            console.log("Executing showFinalContinueButton");
            updateStoryScreenStats(); // Update stats on story screen
            document.getElementById('storyChoices').style.display = 'none'; // Hide story choices
            document.getElementById('storyStats').style.display = 'block'; // Show stats at the end
            document.getElementById('continueToBattleButton').style.display = 'none'; // Ensure the button is hidden
            
            inStoryEvent = false; // Story event is now over
            gameState = 'storyComplete'; // Set game state to storyComplete
            
            // Ensure the button is clickable
            const continueButton = document.getElementById('continueJourneyFromStoryButton');
            continueButton.onclick = continueJourneyFromStory;
            
            console.log("Continue journey button should now be visible");
            
            ensureButtonVisibility(); // Update button visibility
            autoSave();
            updateLoadGameButton();
        }

        function startTreantBattle() {
            console.log("Executing startTreantBattle");
            treantEncountered = true;
            enemies = [createEnemyByType('Treant')];
            gameState = 'playerTurn';
            updateButtonStates();
            drawGame();
            canvas.style.display = 'block';
            document.getElementById('gameButtons').style.display = 'block';
        }

        function continueJourneyFromCamp() {
			console.log("Executing continueJourneyFromCamp");
			hideCampScreen();
			document.getElementById('continueJourneyFromCampButton').style.display = 'none';
			resetPurchasedItems(); // Reset purchased items when leaving camp
			continueJourney();
		}
        
        function continueJourneyFromStory() {
            console.log("Executing continueJourneyFromStory");
            hideStoryEventScreen();
            inStoryEvent = false;
            gameState = 'exploring'; // Set game state to exploring
            ensureButtonVisibility(); // Update button visibility
            continueJourney();
        }
		
	    	function hideDuelEventScreen() {
			document.getElementById('duelEventScreen').style.display = 'none';
		}

        function hideStoryEventScreen() {
			document.getElementById('storyEventScreen').style.display = 'none';
		}

        function updateStoryScreenStats() {
            console.log("Executing updateStoryScreenStats");
            const statsMessage = `Health: ${player.health}/${player.maxHealth}<br>
            Min Damage: ${player.minDamage}<br>
            Max Damage: ${player.maxDamage}<br>
            XP: ${player.experience}/${player.xpToNextLevel}<br>
            Current Gold: ${player.gold}<br><br>
            Camp Bank: ${player.campBank} Gold`;

            document.getElementById('storyStats').innerHTML = statsMessage;
        }

        // Utility function to remove event listeners
        function removeEventListeners(...buttonIds) {
            buttonIds.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                const oldElement = button.cloneNode(true);
                button.parentNode.replaceChild(oldElement, button);
            });
        }

        function showStorySkillSelection() {
    console.log("Showing story skill selection for " + player.class);
    const skillSelection = document.getElementById('storySkillSelection');
    
    skillSelection.style.display = 'block';
    document.getElementById('continueJourneyFromStoryButton').style.display = 'none';
    document.getElementById('storyChoices').style.display = 'none';

    const mageSkills = document.getElementById('storySkillSelectionMageSkills');
    const warriorSkills = document.getElementById('storySkillSelectionWarriorSkills');
    const clericSkills = document.getElementById('storySkillSelectionClericSkills');
    const rogueSkills = document.getElementById('storySkillSelectionRogueSkills');

    mageSkills.style.display = 'none';
    warriorSkills.style.display = 'none';
    clericSkills.style.display = 'none';
    rogueSkills.style.display = 'none';

    if (player.class === 'Mage') {
        mageSkills.style.display = 'block';
    } else if (player.class === 'Warrior') {
        warriorSkills.style.display = 'block';
    } else if (player.class === 'Cleric') {
        clericSkills.style.display = 'block';
    } else if (player.class === 'Rogue') {
        rogueSkills.style.display = 'block';
    }
    
    ensureButtonVisibility();
}

        function showBattleSkillSelection() {
    console.log("Showing battle skill selection for " + player.class);
    const skillSelection = document.getElementById('skillSelection');
    
    skillSelection.style.display = 'block';
    document.getElementById('continueJourneyButton').style.display = 'none';
    document.getElementById('returnToCampButton').style.display = 'none';

    const mageSkills = document.getElementById('skillSelectionMageSkills');
    const warriorSkills = document.getElementById('skillSelectionWarriorSkills');
    const clericSkills = document.getElementById('skillSelectionClericSkills');
    const rogueSkills = document.getElementById('skillSelectionRogueSkills');

    mageSkills.style.display = 'none';
    warriorSkills.style.display = 'none';
    clericSkills.style.display = 'none';
    rogueSkills.style.display = 'none';

    if (player.class === 'Mage') {
        mageSkills.style.display = 'block';
    } else if (player.class === 'Warrior') {
        warriorSkills.style.display = 'block';
    } else if (player.class === 'Cleric') {
        clericSkills.style.display = 'block';
    } else if (player.class === 'Rogue') {
        rogueSkills.style.display = 'block';
    }
    
    ensureButtonVisibility();
}

        function showLevelUpMessage() {
            let levelUpMessage = `You leveled up! Gained ${player.healthGain} health, +${player.minDamageGain} min damage, +${player.maxDamageGain} max damage.`;
            document.getElementById('storyLevelUpMessage').innerHTML = levelUpMessage;
            document.getElementById('storyLevelUpMessage').style.display = 'block';
            
            // Clear the message after 5 seconds
            setTimeout(() => {
                document.getElementById('storyLevelUpMessage').style.display = 'none';
                document.getElementById('storyLevelUpMessage').innerHTML = '';
            }, 5000);
        }
        
        function setupClassSkills() {
    console.log("Setting up class skills for:", player.class);
    if (player.class === 'Mage') {
        player.specialSkills = {
            Thunder: {
                name: "Thunder",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage + 1;
                    enemies[selectedEnemyIndex].stunnedTurns = 1;
                    return damage;
                }
            },
            Fireball: {
                name: "Fireball",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage + 2;
                    enemies[selectedEnemyIndex].burnedTurns = 2;
                    return damage;
                }
            },
            HailStorm: {
                name: "Hail Storm",
                use: function() {
                    let totalDamage = 0;
                    enemies.forEach(enemy => {
                        const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage + 1;
                        totalDamage += damage;
                    });
                    return totalDamage;
                }
            }
        };
        
    } else if (player.class === 'Warrior') {
        player.specialSkills = {
            DoubleAttack: {
                name: "Double Attack",
                use: function() {
                    let totalDamage = 0;
                    for (let i = 0; i < 2; i++) {
                        const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage;
                        totalDamage += damage;
                    }
                    return totalDamage;
                }
            },
            StoneSkin: {
                name: "Stone Skin",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage;
                    player.defending = true;
                    return damage;
                }
            },
            LifeAttack: {
                name: "Life Attack",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage;
                    const healAmount = Math.floor(damage / 2);
                    player.health = Math.min(player.health + healAmount, player.maxHealth);
                    return damage;
                }
            }
        };
       
    } else if (player.class === 'Cleric') {
        player.specialSkills = {
            HolyLight: {
                name: "Holy Light",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage + 1;
                    enemies[selectedEnemyIndex].exposed = true;
                    return damage;
                }
            },
            LifeTransfer: {
                name: "Life Transfer",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage + 1;
                    player.health = Math.min(player.health + damage, player.maxHealth);
                    return damage;
                }
            },
            ShieldOfLight: {
                name: "Shield of Light",
                use: function() {
                    player.shieldOfLight = 2;
                    player.maxDamage += 2;
                    return 0;
                }
            }
        };
       
    } else if (player.class === 'Rogue') {
        player.specialSkills = {
            BlindShot: {
                name: "Blind Shot",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage + 1;
                    enemies[selectedEnemyIndex].blind = 100;
                    return damage;
                }
            },
            ToxicStab: {
                name: "Toxic Stab",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage + 2;
                    enemies[selectedEnemyIndex].poison = (enemies[selectedEnemyIndex].poison || 0) + 1;
                    return damage;
                }
            },
            PerfectParry: {
                name: "Perfect Parry",
                use: function() {
                    const damage = Math.floor(Math.random() * (player.maxDamage - player.minDamage + 1)) + player.minDamage + 1;
                    player.parry = true;
                    return damage;
                }
            }
        };
        
    }
    
    console.log("Special skills set up:", player.specialSkills);
    
}

        function selectSpecialSkill(skillName) {
    console.log("Selecting special skill: " + skillName);
    player.specialSkill = player.specialSkills[skillName];
    console.log("Selected skill:", player.specialSkill);
    
    // Hide the skill selection after choosing a skill
    document.getElementById('skillSelection').style.display = 'none';
    document.getElementById('storySkillSelection').style.display = 'none';

    // Update the special attack button
    updateSpecialAttackButton();

    if (inStoryEvent) {
        showFinalContinueButton();
    } else {
        document.getElementById('continueJourneyButton').style.display = 'inline-block';
        document.getElementById('returnToCampButton').style.display = 'inline-block';
    }

    console.log("Journey and Camp buttons should now be visible");

    // Save the game after selecting a skill
    saveGame();

    // If we're in a battle, redraw the game
    if (gameState === 'playerTurn' || gameState === 'enemyTurn') {
        drawGame();
    }
    
    ensureButtonVisibility();
}

        function updateSpecialAttackButton() {
    const specialAttackButton = document.getElementById('specialAttackButton');
    if (player.specialSkill && player.specialSkillUnlocked) {
        specialAttackButton.style.display = 'inline-block';
        if (player.specialAttackCooldown > 0) {
            specialAttackButton.textContent = `${player.specialSkill.name} (${player.specialAttackCooldown})`;
            specialAttackButton.classList.remove('available');
            specialAttackButton.classList.add('cooldown');
            specialAttackButton.disabled = true;
        } else {
            specialAttackButton.textContent = player.specialSkill.name;
            specialAttackButton.classList.add('available');
            specialAttackButton.classList.remove('cooldown');
            specialAttackButton.disabled = false;
        }
    } else {
        specialAttackButton.style.display = 'none';
    }
}

        function ensureButtonVisibility() {
            const continueButton = document.getElementById('continueJourneyButton');
            const campButton = document.getElementById('returnToCampButton');
            const storyButton = document.getElementById('continueJourneyFromStoryButton');
            const storyChoices = document.getElementById('storyChoices');
            const skillSelection = document.getElementById('skillSelection');
            const storySkillSelection = document.getElementById('storySkillSelection');
        
            // Check if skill selection is active
            const isSkillSelectionActive = (skillSelection && skillSelection.style.display !== 'none') || 
                                           (storySkillSelection && storySkillSelection.style.display !== 'none');
        
            console.log("Current state:", { inStoryEvent, gameState, isSkillSelectionActive });
        
            if (isSkillSelectionActive) {
                // If skill selection is active, hide all journey buttons
                storyButton.style.display = 'none';
                continueButton.style.display = 'none';
                campButton.style.display = 'none';
            } else if (inStoryEvent) {
                // In a story event
                if (storyChoices.style.display !== 'none') {
                    // Choices are still visible, buttons should be hidden
                    storyButton.style.display = 'none';
                    continueButton.style.display = 'none';
                    campButton.style.display = 'none';
                } else {
                    // Choices are hidden, story continue button should be visible
                    storyButton.style.display = 'inline-block';
                    continueButton.style.display = 'none';
                    campButton.style.display = 'none';
                }
            } else if (gameState === 'storyComplete') {
                // Story is complete, show the continue journey button
                storyButton.style.display = 'inline-block';
                continueButton.style.display = 'none';
                campButton.style.display = 'none';
            } else if (gameState === 'victory') {
                // Victory screen, show continue journey and return to camp buttons
                storyButton.style.display = 'none';
                continueButton.style.display = 'inline-block';
                campButton.style.display = 'inline-block';
            } else {
                // Default case, hide all buttons
                storyButton.style.display = 'none';
                continueButton.style.display = 'none';
                campButton.style.display = 'none';
            }
        
            console.log("Button visibility updated:", {
                storyButton: storyButton.style.display,
                continueButton: continueButton.style.display,
                campButton: campButton.style.display
            });
        }

        setInterval(ensureButtonVisibility, 5000); // Check every 5 seconds

        window.onerror = function(message, source, lineno, colno, error) {
    console.error("An error occurred:", message, "at", source, ":", lineno);
    ensureButtonVisibility(); // Try to recover
    return false;
};

        function buyTent(tentNumber, cost) {
            if (player.campBank >= cost) {
                player.campBank -= cost;
                player.tents++;
                console.log(`Bought tent ${tentNumber}. New tent count:`, player.tents);
                document.getElementById(`${getTentNumberWord(tentNumber)}TentButton`).style.display = 'none';
                if (tentNumber < 5) {
                    document.getElementById(`${getTentNumberWord(tentNumber + 1)}TentButton`).style.display = 'block';
                }
                
                if (!duelEventsUnlocked) {
                    duelEventsUnlocked = true;
                    console.log("Duel events unlocked!");
                    alert("You've unlocked Duel Events!");
                }
                
                showCampScreen(); // Refresh the entire camp screen
            } else {
                alert("Not enough gold in the Camp Bank!");
            }
        }

        function getTentNumberWord(number) {
            const words = ['', 'second', 'third', 'fourth', 'fifth'];
            return words[number - 1];
        }

        function updateCampMessage() {
            document.getElementById('campMessage').innerHTML = `Current Gold: ${player.gold}<br>Camp Bank: ${player.campBank} Gold<br>Tents: ${player.tents}`;
        }

        function startDuelEvent() {
            console.log("Starting duel event");
            const classes = ['Warrior', 'Mage', 'Cleric', 'Rogue'];
            const enemyClass = classes[Math.floor(Math.random() * classes.length)];
            const enemy = createEnemyCharacter(enemyClass);
            
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'none';
            document.getElementById('duelEventScreen').style.display = 'block';
            document.getElementById('duelText').innerHTML = `You've encountered a ${enemyClass} who challenges you to a duel!`;
            document.getElementById('startDuelButton').onclick = () => startDuelBattle(enemy);
        }

        function createEnemyCharacter(characterClass) {
            const enemy = {
                type: characterClass,  // Add this line
                class: characterClass,
                health: 50,
                maxHealth: 50,
                minDamage: 1,
                maxDamage: 6,
                specialSkill: getRandomSkill(characterClass),
                specialAttackCooldown: 0  // Add this line
            };
            return enemy;
        }

        function getRandomSkill(characterClass) {
            // Return a random skill based on the character class
            const skills = {
                Warrior: ['DoubleAttack', 'StoneSkin', 'LifeAttack'],
                Mage: ['Thunder', 'Fireball', 'HailStorm'],
                Cleric: ['HolyLight', 'LifeTransfer', 'ShieldOfLight'],
                Rogue: ['BlindShot', 'ToxicStab', 'PerfectParry']
            };
            return skills[characterClass][Math.floor(Math.random() * skills[characterClass].length)];
        }

        function startDuelBattle(enemy) {
    console.log("Starting duel battle");
    currentBattleExpGained = 0;
    enemies = [enemy];
    gameState = 'playerTurn';  // Change this from 'duel' to 'playerTurn'
    document.getElementById('duelEventScreen').style.display = 'none';
    document.getElementById('gameCanvas').style.display = 'block';
    document.getElementById('gameButtons').style.display = 'block';
    
    // Ensure all battle buttons are enabled
    document.getElementById('attackButton').disabled = false;
    document.getElementById('defendButton').disabled = false;
    document.getElementById('specialAttackButton').disabled = false;
    document.getElementById('retreatButton').disabled = false;
    
    updateButtonStates();
    drawGame();
    showPlayerTurnNotification();
}

        function showDuelVictoryScreen() {
    const victoryScreen = document.getElementById('duelVictoryScreen');
    victoryScreen.style.display = 'block';
    canvas.style.display = 'none';
    document.getElementById('gameButtons').style.display = 'none';

    document.getElementById('duelVictoryMessage').innerHTML = `You've defeated the ${enemies[0].class}!`;
    document.getElementById('recruitButton').onclick = recruitCharacter;
    document.getElementById('continueDuelJourneyButton').onclick = continueDuelJourney;
    autoSave();
    updateLoadGameButton();
}

        function recruitCharacter() {
            if (player.recruitedCharacters === undefined) {
                player.recruitedCharacters = [];
            }
            if (player.recruitedCharacters.length < player.tents - 1) {
                player.recruitedCharacters.push(enemies[0]);
                alert(`You've recruited the ${enemies[0].class}!`);
                document.getElementById('recruitButton').style.display = 'none';
            } else {
                alert("You don't have enough tents to recruit this character!");
            }
        }

        function continueDuelJourney() {
            document.getElementById('duelVictoryScreen').style.display = 'none';
            
            continueJourney();
        }

        function useEnemySpecialSkill(enemy) {
    console.log(`Enemy ${enemy.class} using special skill: ${enemy.specialSkill}`);
    switch(enemy.specialSkill) {
        // Warrior Skills
        case 'DoubleAttack':
            let damage1 = Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage;
            let damage2 = Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage;
            return damage1 + damage2;
        case 'StoneSkin':
            enemy.defending = true;
            return Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage;
        case 'LifeAttack':
            let lifeDamage = Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage;
            enemy.health = Math.min(enemy.health + Math.floor(lifeDamage / 2), enemy.maxHealth);
            return lifeDamage;

        // Mage Skills
        case 'Thunder':
            player.stunnedTurns = 1;
            return Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage + 2;
        case 'Fireball':
            player.burnedTurns = 2;
            return Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage + 2;
        case 'HailStorm':
            return Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage + 3;

        // Cleric Skills
        case 'HolyLight':
            player.exposed = true;
            return Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage + 1;
        case 'LifeTransfer':
            let transferDamage = Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage + 1;
            enemy.health = Math.min(enemy.health + transferDamage, enemy.maxHealth);
            return transferDamage;
        case 'ShieldOfLight':
            enemy.shieldOfLight = 2;
            enemy.maxDamage += 2;
            return 0;

        // Rogue Skills
        case 'BlindShot':
            player.blind = 100;
            return Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage + 1;
        case 'ToxicStab':
            const damage = Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage + 2;
            player.health -= damage;
            if (player.poisonCounter === 0) {
                player.poisonCounter = 1;
                console.log("Player has been poisoned!");
            }
            return damage;
        case 'PerfectParry':
            player.parryNextAttack = true;  // Set a flag for the player to parry the next attack
            console.log("Enemy used Perfect Parry, player's next attack will be parried");
            return Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage + 1;

        default:
            console.log("Unknown enemy skill, using default attack");
            return Math.floor(Math.random() * (enemy.maxDamage - enemy.minDamage + 1)) + enemy.minDamage;
    }
}

        // Touch controls
        function handleTouch(event) {
    event.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    const touch = event.changedTouches[0];
    const x = (touch.clientX - rect.left) * scaleX;
    const y = (touch.clientY - rect.top) * scaleY;
    
    // Check if touch is on an enemy
    for (let i = 0; i < enemies.length; i++) {
        const enemyX = 650;
        const enemyY = 180 + (i * 130);
        if (x >= enemyX && x <= enemyX + 50 && y >= enemyY && y <= enemyY + 50) {
            selectedEnemyIndex = i;
            drawGame(); // Redraw to show selection
            return;
        }
    }
    
    // If not on an enemy, check if touch is on a button
    if (isPointInButton(x, y, 'attackButton')) {
        playerAttack();
    } else if (isPointInButton(x, y, 'defendButton')) {
        playerDefend();
    } else if (isPointInButton(x, y, 'retreatButton')) {
        playerRetreat();
    } else if (isPointInButton(x, y, 'specialAttackButton')) {
        playerSpecialAttack();
    }
}

        // Add this event listener
        canvas.addEventListener('touchend', handleTouch);
        
        function isPointInButton(x, y, buttonId) {
            const button = document.getElementById(buttonId);
            const rect = button.getBoundingClientRect();
            return (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
        }
        
        // Only add touch listeners once
        canvas.addEventListener('touchend', handleTouch);
        
        function resizeGame() {
    const gameContainer = document.getElementById('gameContainer');
    const game = document.getElementById('gameCanvas');
    const gameAspectRatio = 800 / 500;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;

    let newWidth, newHeight;

    if (windowWidth / windowHeight > gameAspectRatio) {
        newHeight = Math.min(windowHeight - 100, 500); // Cap at original height
        newWidth = newHeight * gameAspectRatio;
    } else {
        newWidth = Math.min(windowWidth, 800); // Cap at original width
        newHeight = newWidth / gameAspectRatio;
    }

    gameContainer.style.width = `${newWidth}px`;
    game.style.width = `${newWidth}px`;
    game.style.height = `${newHeight}px`;

    // Only change actual canvas dimensions on mobile
    if (isMobile()) {
        game.width = newWidth;
        game.height = newHeight;
    } else {
        game.width = 800;
        game.height = 500;
    }

    const ctx = game.getContext('2d');
    ctx.setTransform(game.width / 800, 0, 0, game.height / 500, 0, 0);

    if (gameState !== 'mainMenu') {
        drawGame();
    }
}
        
        function createMobileMenu() {
            const menu = document.createElement('div');
            menu.id = 'mobileMenu';
            menu.innerHTML = `
                <button id="menuToggle">☰</button>
                <div id="menuContent" style="display:none;">
                    <button id="attackBtn">Attack</button>
                    <button id="defendBtn">Defend</button>
                    <button id="specialBtn">Special</button>
                </div>
            `;
            document.body.appendChild(menu);
        
            document.getElementById('menuToggle').addEventListener('click', () => {
                const content = document.getElementById('menuContent');
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            });
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                   || window.innerWidth <= 768;
        }
        
        function saveGame() {
            const gameData = {
                player: {
                    ...player,
                    specialSkill: player.specialSkill ? { name: player.specialSkill.name } : null,
                    merchantTent: player.merchantTent
                },
                enemies: enemies,
                gameState: gameState,
                currentStory: currentStory,
                treantEncountered: treantEncountered,
                duelEventsUnlocked: duelEventsUnlocked
            };
            localStorage.setItem('rpgGameSave', JSON.stringify(gameData));
            console.log('Game saved successfully!');
            updateLoadGameButton();
        }
        
        function loadGame() {
    const savedGame = localStorage.getItem('rpgGameSave');
    if (savedGame) {
        const gameData = JSON.parse(savedGame);
        player = gameData.player;
        enemies = gameData.enemies;
        gameState = gameData.gameState;
        currentStory = gameData.currentStory;
        treantEncountered = gameData.treantEncountered;
        duelEventsUnlocked = gameData.duelEventsUnlocked;

        // Reconstruct the special skill
        if (player.specialSkill) {
            setupClassSkills();
            player.specialSkill = player.specialSkills[player.specialSkill.name];
        }

        setupGameAfterLoad();
        startGame(false); // Call startGame with isNewGame set to false

        // Show camp screen after loading (this will also show the shop if merchant tent is purchased)
        showCampScreen();
    } else {
        alert('No saved game found!');
    }
}

        function autoSave() {
            saveGame();
            console.log('Game auto-saved');
        }
        
        function hideAllScreens() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('characterSelectScreen').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'none';
            document.getElementById('gameVictoryScreen').style.display = 'none';
            document.getElementById('gameDefeatScreen').style.display = 'none';
            document.getElementById('duelEventScreen').style.display = 'none';
            document.getElementById('storyEventScreen').style.display = 'none';
        }
        
        function setupGameAfterLoad() {
            updateGameUI();
            resizeGame();
            if (gameState === 'playerTurn' || gameState === 'enemyTurn') {
                drawGame();
            }
            
            // Re-add event listener for special attack button
            const specialAttackButton = document.getElementById('specialAttackButton');
            specialAttackButton.removeEventListener('click', playerSpecialAttack);
            specialAttackButton.addEventListener('click', playerSpecialAttack);
        }
        
        function updateGameUI() {
            // Update special attack button
            if (player.specialSkill) {
                document.getElementById('specialAttackButton').style.display = 'inline-block';
                document.getElementById('specialAttackButton').textContent = player.specialSkill.name;
            } else {
                document.getElementById('specialAttackButton').style.display = 'none';
            }
            
            // Update other UI elements as needed
            updateCampMessage();
            updateTentButtons();
        }
        
        function updateLoadGameButton() {
            const loadGameButton = document.getElementById('loadGameButton');
            const savedGame = localStorage.getItem('rpgGameSave');
            loadGameButton.disabled = !savedGame;
        }
        
        function applyPoisonDamage() {
        if (player.poisonCounter && player.poisonCounter > 0) {
            const poisonDamage = player.poisonCounter;
            player.health -= poisonDamage;
            console.log(`Player takes ${poisonDamage} poison damage. Health reduced to ${player.health}`);
            damageDisplay.player.damage += poisonDamage;
            damageDisplay.player.x = 75;
            damageDisplay.player.y = 150;
            damageDisplay.player.alpha = 1;
            player.poisonCounter++;
            console.log(`Poison counter increased to ${player.poisonCounter}`);
    
            if (player.health <= 0) {
                console.log("Player died from poison");
                gameState = 'defeat';
                setTimeout(() => {
                    showDefeatScreen();
                }, 1000);
            }
        }
}

        function drawTurnIndicator() {
      ctx.save();
      
      const text = gameState === 'playerTurn' ? "Player's Turn" : "Enemy Turn";
      const fontSize = 24;
      ctx.font = `bold ${fontSize}px Arial`;
      
      const textWidth = ctx.measureText(text).width;
      const padding = 10;
      const rectWidth = textWidth + padding * 2;
      const rectHeight = fontSize + padding * 2;
      
      // Always position at the bottom center of the 800x500 game area
      const rectX = (800 - rectWidth) / 2;
      const rectY = 500 - rectHeight - 10; // 10px from the bottom
      
      ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
      ctx.fillRect(rectX, rectY, rectWidth, rectHeight);
      
      ctx.fillStyle = "white";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(text, 400, 500 - rectHeight / 2 - 10);
      
      ctx.restore();
  }
  
        function updateSpecialAttackButton() {
      const specialAttackButton = document.getElementById('specialAttackButton');
      if (player.specialSkill && player.specialSkillUnlocked) {
          specialAttackButton.style.display = 'inline-block';
          if (player.specialAttackCooldown > 0) {
              specialAttackButton.textContent = `${player.specialSkill.name} (${player.specialAttackCooldown})`;
              specialAttackButton.classList.remove('available');
              specialAttackButton.classList.add('cooldown');
              specialAttackButton.disabled = true;
          } else {
              specialAttackButton.textContent = player.specialSkill.name;
              specialAttackButton.classList.add('available');
              specialAttackButton.classList.remove('cooldown');
              specialAttackButton.disabled = false;
          }
      } else {
          specialAttackButton.style.display = 'none';
      }
  }
  
        function updateButtonStates() {
      const buttons = ['attackButton', 'defendButton', 'retreatButton', 'specialAttackButton'];
      const isPlayerTurn = gameState === 'playerTurn';
  
      buttons.forEach(buttonId => {
          const button = document.getElementById(buttonId);
          if (button) {
              button.disabled = !isPlayerTurn;
              
              if (buttonId === 'specialAttackButton') {
                  if (isPlayerTurn && player.specialAttackCooldown === 0 && player.specialSkill) {
                      button.classList.add('available');
                      button.classList.remove('cooldown');
                      button.disabled = false;
                  } else {
                      button.classList.remove('available');
                      if (player.specialAttackCooldown > 0) {
                          button.classList.add('cooldown');
                      }
                      button.disabled = true;
                  }
              }
          }
      });
  }
  
        function updateShopButtons(isVictoryScreen = false) {
    const buttons = [
        { id: isVictoryScreen ? 'healingPotionButton' : 'campHealingPotionButton', item: 'healingPotion', cost: 100, name: 'Healing Potion', description: 'Heal 25 HP' },
        { id: isVictoryScreen ? 'expBoosterButton' : 'campExpBoosterButton', item: 'expBooster', cost: 200, name: 'EXP Booster', description: 'Double the next XP gained' },
        { id: isVictoryScreen ? 'antidoteButton' : 'campAntidoteButton', item: 'antidote', cost: 300, name: 'Antidote', description: 'Heals poison' },
        { id: isVictoryScreen ? 'lotusButton' : 'campLotusButton', item: 'lotus', cost: 500, name: 'Lotus of Experience', description: 'Grants 10 XP' },
        { id: isVictoryScreen ? 'redPillButton' : 'campRedPillButton', item: 'redPill', cost: 1000, name: 'Red Pill', description: '+1 Min Damage' }
    ];

    buttons.forEach(button => {
        const element = document.getElementById(button.id);
        if (element) {
            if (isVictoryScreen) {
                if (currentVictoryScreenPurchases[button.item]) {
                    element.disabled = true;
                    element.innerHTML = '<div class="button-content"><span class="item-name">Sold Out</span></div>';
                } else {
                    element.disabled = false;
                    element.innerHTML = `
                        <div class="button-content">
                            <span class="item-name">Buy ${button.name}</span>
                            <span class="gold-amount">${button.cost} Gold</span>
                        </div>
                    `;
                    element.onclick = () => buyVictoryItem(button.item, button.cost, button.name);
                }
            } else {
                // Camp shop logic remains unchanged
                if (player.purchasedItems && player.purchasedItems[button.item]) {
                    element.disabled = true;
                    element.innerHTML = '<div class="button-content"><span class="item-name">Sold Out</span></div>';
                } else {
                    element.disabled = false;
                    element.innerHTML = `
                        <div class="button-content">
                            <span class="item-name">Buy ${button.name}</span>
                            <span class="gold-amount">${button.cost} Gold</span>
                        </div>
                    `;
                    element.onclick = () => buyItemInCamp(button.item, button.cost, button.name);
                }
            }
        }
    });
}
  
        function handleMouseClick(event) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      
      let x, y;
      if (event.type === 'touchstart') {
        x = (event.touches[0].clientX - rect.left) * scaleX;
        y = (event.touches[0].clientY - rect.top) * scaleY;
      } else {
        x = (event.clientX - rect.left) * scaleX;
        y = (event.clientY - rect.top) * scaleY;
      }
      
      // Check if click/touch is on an enemy
      for (let i = 0; i < enemies.length; i++) {
          const enemyX = 650;
          const enemyY = 180 + (i * 130);
          if (x >= enemyX && x <= enemyX + 50 && y >= enemyY && y <= enemyY + 50) {
              selectedEnemyIndex = i;
              drawGame(); // Redraw to show selection
              return;
          }
      }
  }
  
  // Create mobile-friendly enemy selection overlay
        function createMobileEnemySelectionOverlay() {
    const overlay = document.createElement('div');
    overlay.id = 'mobileEnemySelectionOverlay';
    overlay.style.position = 'absolute';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.display = 'none'; // Initially hidden
    
    enemies.forEach((enemy, index) => {
      const button = document.createElement('div');
      button.style.position = 'absolute';
      button.style.left = '650px';
      button.style.top = `${180 + (index * 130)}px`;
      button.style.width = '50px';
      button.style.height = '50px';
      button.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
      button.style.border = '2px solid black';
      button.style.borderRadius = '50%';
      button.style.touchAction = 'manipulation';
      
      button.addEventListener('touchstart', (e) => {
        e.preventDefault();
        selectedEnemyIndex = index;
        drawGame();
      });
      
      overlay.appendChild(button);
    });
    
    document.body.appendChild(overlay);
  }
  
  
  canvas.addEventListener('click', handleMouseClick);
  
  // Call this function in drawGame and after each turn
  
  
  			function addDeveloperGold() {
  				player.gold += 1500;
  				updateGoldMessage();
  				updateVictoryScreenStats();
  				alert("Added 1500 gold to the player!");
  			}

        document.getElementById('developerGoldButton').onclick = addDeveloperGold;

        document.getElementById('loadGameButton').addEventListener('click', () => {
    loadGame();
    startGame(false);
      });
        document.getElementById('saveGameButton').onclick = function() {
            saveGame();
            const saveButton = this;
            saveButton.textContent = 'Saved!';
            setTimeout(() => {
                saveButton.textContent = 'Save Game';
            }, 2000);
        };

        window.addEventListener('resize', resizeGame);
        document.querySelectorAll('img').forEach(img => {
    console.log('Image found:', img.src, img.parentElement);
});

        // In-game skill buttons
        document.getElementById('thunderButton').addEventListener('click', () => selectSpecialSkill('Thunder'));
        document.getElementById('fireballButton').addEventListener('click', () => selectSpecialSkill('Fireball'));
        document.getElementById('hailStormButton').addEventListener('click', () => selectSpecialSkill('HailStorm'));
        document.getElementById('doubleAttackButton').addEventListener('click', () => selectSpecialSkill('DoubleAttack'));
        document.getElementById('stoneSkinButton').addEventListener('click', () => selectSpecialSkill('StoneSkin'));
        document.getElementById('lifeAttackButton').addEventListener('click', () => selectSpecialSkill('LifeAttack'));
        document.getElementById('holyLightButton').addEventListener('click', () => selectSpecialSkill('HolyLight'));
        document.getElementById('lifeTransferButton').addEventListener('click', () => selectSpecialSkill('LifeTransfer'));
        document.getElementById('shieldOfLightButton').addEventListener('click', () => selectSpecialSkill('ShieldOfLight'));
        document.getElementById('blindShotButton').addEventListener('click', () => selectSpecialSkill('BlindShot'));
        document.getElementById('toxicStabButton').addEventListener('click', () => selectSpecialSkill('ToxicStab'));
        document.getElementById('perfectParryButton').addEventListener('click', () => selectSpecialSkill('PerfectParry'));
        
        // Story event skill buttons
        document.getElementById('storyThunderButton').addEventListener('click', () => selectSpecialSkill('Thunder'));
        document.getElementById('storyFireballButton').addEventListener('click', () => selectSpecialSkill('Fireball'));
        document.getElementById('storyHailStormButton').addEventListener('click', () => selectSpecialSkill('HailStorm'));
        document.getElementById('storyDoubleAttackButton').addEventListener('click', () => selectSpecialSkill('DoubleAttack'));
        document.getElementById('storyStoneSkinButton').addEventListener('click', () => selectSpecialSkill('StoneSkin'));
        document.getElementById('storyLifeAttackButton').addEventListener('click', () => selectSpecialSkill('LifeAttack'));
        document.getElementById('storyHolyLightButton').addEventListener('click', () => selectSpecialSkill('HolyLight'));
        document.getElementById('storyLifeTransferButton').addEventListener('click', () => selectSpecialSkill('LifeTransfer'));
        document.getElementById('storyShieldOfLightButton').addEventListener('click', () => selectSpecialSkill('ShieldOfLight'));
        document.getElementById('storyBlindShotButton').addEventListener('click', () => selectSpecialSkill('BlindShot'));
        document.getElementById('storyToxicStabButton').addEventListener('click', () => selectSpecialSkill('ToxicStab'));
        document.getElementById('storyPerfectParryButton').addEventListener('click', () => selectSpecialSkill('PerfectParry'));


        // Add event listeners for main menu and gameplay buttons
        document.getElementById('startGameButton').addEventListener('click', () => startGame(true));
        //document.getElementById('resetButton').addEventListener('click', developerReset); // Add event listener for reset button

        
        
        document.getElementById('secondTentButton').addEventListener('click', () => buyTent(2, 1500));
        document.getElementById('thirdTentButton').addEventListener('click', () => buyTent(3, 2000));
        document.getElementById('fourthTentButton').addEventListener('click', () => buyTent(4, 2500));
        document.getElementById('fifthTentButton').addEventListener('click', () => buyTent(5, 3000));
        document.getElementById('merchantTentButton').addEventListener('click', buyMerchantTent);

        // Add event listeners for victory screen buttons
        document.getElementById('continueJourneyButton').onclick = continueJourney;
        document.getElementById('returnToCampButton').addEventListener('click', returnToCamp);
        //document.getElementById('developerButton').addEventListener('click', () => {
           // player.level = 3;
            //checkLevelUp();
            //updateVictoryScreenStats();
        //});
        //document.getElementById('developerButton5').addEventListener('click', () => {
           // player.level = 5;
           // checkLevelUp();
            //updateVictoryScreenStats();
        //});

        // Add event listeners for defeat screen buttons
        document.getElementById('tryAgainButton').addEventListener('click', () => {
            hideDefeatScreen();
            resetGame();
        });

        // Add event listeners for camp screen buttons
        document.getElementById('storeGoldButton').addEventListener('click', storeGoldInCamp);
        document.getElementById('continueJourneyFromCampButton').onclick = function() {
			console.log("Continue journey from camp button clicked");
			continueJourneyFromCamp();
		};

        // Add event listeners for story event screen buttons
        document.getElementById('storyChoice1Button').addEventListener('click', () => {
            console.log("storyChoice1Button clicked");
            if (currentStory === STORY_OLD_MAN) {
                handleOldManChoice1();
            } else if (currentStory === STORY_TREANT) {
                handleTreePoke1();
            }
        });
        document.getElementById('storyChoice2Button').addEventListener('click', () => {
            console.log("storyChoice2Button clicked");
            if (currentStory === STORY_OLD_MAN) {
                handleOldManChoice2();
            } else if (currentStory === STORY_TREANT) {
                handleTreeAsk();
            }
        });
        document.getElementById('storyChoice3Button').addEventListener('click', () => {
            console.log("storyChoice3Button clicked");
            if (currentStory === STORY_OLD_MAN) {
                handleOldManChoice3();
            } else if (currentStory === STORY_TREANT) {
                handleTreeLeave();
            }
        });
        document.getElementById('continueJourneyFromStoryButton').onclick = continueJourney;
    </script>
</body>
</html>